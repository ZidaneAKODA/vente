<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>AFRICA PHONE - Gestion des Ventes</title>
  <!-- jsPDF and jsPDF-AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <!-- Link to the manifest -->
<link rel="manifest" href="manifest.json">
<!-- Set the theme color (should match the one in your manifest) -->
<meta name="theme-color" content="#006064">

  <style>
        /* Masquage automatique des prix pour les employés */
    body.role-employe .price-label {
      display: none !important;
    }

    /* Désactivation globale de la sélection de texte (sauf input et textarea) */
    body *:not(input):not(textarea) {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    /* Désactivation de l'effet de sélection (outline) sur boutons, liens et éléments cliquables */
    button, a, div.section, div.nav-item, div.shortcut {
      outline: none;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    /* Preloader Styles */
    #preloader {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      z-index: 5000;
      background-color: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid var(--primary-color);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Sale Loader Popup Styles */
    #saleLoader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 6000;
      background: rgba(255,255,255,0.8);
      display: none;
      align-items: center;
      justify-content: center;
    }
    #saleLoader .loader-content {
      text-align: center;
    }
    #saleLoader .loader-content p {
      font-size: 16px;
      color: var(--primary-color);
      margin-top: 10px;
    }
    /* Toast Notification */
    #toast {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #007BFF;
      color: white;
      padding: 12px 24px;
      border-radius: 5px;
      z-index: 3000;
      font-size: 16px;
    }
    /* Sale Stepper Styles */
    .sale-step {
      display: none;
      animation: slideIn 0.3s ease-in-out;
    }
    .sale-step.active {
      display: block;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(100%); }
      to { opacity: 1; transform: translateX(0); }
    }
    .step-navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
    }
    /* Barre de progression fluide */
    .progress-container {
      position: relative;
      width: 100%;
      height: 8px;
      background: #f0f0f0;
      border-radius: 4px;
      margin: 10px 0;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: var(--primary-color);
      transition: width 0.4s ease;
    }
    #progressText {
      margin-top: 5px;
      font-size: 14px;
      color: var(--text-color);
      text-align: center;
      display: block;
    }
    /* CSS Variables */
    :root {
      --primary-color: #006064;
      --secondary-color: #004d40;
      --accent-color: #ff6f00;
      --bg-color: #f5f7fa;
      --white: #ffffff;
      --text-color: #333;
      --border-radius: 8px;
      --shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    /* Global Reset & Mobile Base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      overflow-x: hidden;
    }
    input, button, textarea, select {
      font-family: inherit;
      font-size: 18px;
    }
    /* App container and screens */
    #app {
      padding-bottom: 60px;
    }
    .screen {
      display: none;
      padding: 15px;
    }
    .screen.active {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    header {
      text-align: center;
      margin-bottom: 15px;
      position: relative;
    }
    header h1 {
      font-size: 22px;
      color: var(--primary-color);
    }
    .back-btn {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--primary-color);
    }
    .logo {
      font-size: 24px;
      font-weight: bold;
      color: var(--accent-color);
      margin-bottom: 5px;
    }
    .timestamp {
      font-size: 14px;
      color: var(--secondary-color);
      margin-top: 5px;
    }
    /* Form sections */
    .form-section {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }
    .form-section h2 {
      margin-bottom: 15px;
      color: var(--primary-color);
      font-size: 20px;
      text-align: center;
    }
    .vente-form label {
      font-weight: 500;
      margin-bottom: 8px;
      display: block;
      font-size: 16px;
    }
    .vente-form input,
    .vente-form textarea,
    .vente-form button,
    .vente-form select {
      width: 100%;
      padding: 12px;
      margin-bottom: 16px;
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      font-size: 16px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .vente-form input:focus,
    .vente-form textarea:focus,
    .vente-form select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 8px rgba(0, 96, 100, 0.2);
      outline: none;
    }
    /* Modern Input Fields with Icons */
    .input-with-icon {
      position: relative;
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }
    .input-with-icon i {
      position: absolute;
      left: 10px;
      font-size: 24px;
      color: var(--primary-color);
    }
    .input-with-icon input {
      width: 100%;
      padding: 10px 10px 10px 40px;
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .input-with-icon input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 8px rgba(0, 96, 100, 0.2);
      outline: none;
    }
    /* Boutons Modernes Inspirés des Apps Mobiles */
    .btn-modern {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 14px;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      border: none;
      border-radius: 50px;
      background: linear-gradient(45deg, #1877F2, #0056b3);
      color: white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: transform 0.1s ease-in-out, box-shadow 0.2s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      outline: none;
      margin-bottom: 10px;
    }
    .btn-modern:active {
      transform: scale(0.96);
    }
    .btn-modern::after {
      content: "";
      position: absolute;
      width: 200%;
      height: 200%;
      background: rgba(255, 255, 255, 0.3);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      border-radius: 50%;
      transition: transform 0.4s ease-out;
      pointer-events: none;
    }
    .btn-modern:active::after {
      transform: translate(-50%, -50%) scale(1);
    }
    .btn-modern i {
      margin-right: 8px;
      font-size: 24px;
    }
    .btn-modern.secondary {
      background: #E4E6EB;
      color: black;
      box-shadow: none;
    }
    /* Stock Section */
    .cards-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .product-card {
      background: var(--white);
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      padding: 12px;
      width: calc(50% - 10px);
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
    }
    #stock-category .product-card {
      width: 100% !important;
    }
    .product-icon {
      font-size: 36px;
      margin-right: 10px;
    }
    .product-details h3 {
      margin: 0 0 5px;
      font-size: 18px;
    }
    .price-item {
      background: var(--white);
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      padding: 12px;
      margin-bottom: 10px;
      font-size: 18px;
    }
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      padding: 15px;
    }
    .modal-content {
      background: var(--white);
      border-radius: var(--border-radius);
      width: 100%;
      max-width: 500px;
      max-height: 90%;
      overflow-y: auto;
      padding: 15px;
      position: relative;
      box-shadow: var(--shadow);
    }
    .modal-content h2 {
      margin-bottom: 10px;
      text-align: center;
      font-size: 20px;
      color: var(--primary-color);
    }
    .modal .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 26px;
      font-weight: bold;
      color: var(--text-color);
      cursor: pointer;
    }
    /* Bottom Navigation Modernisée */
    .bottom-nav-pro {
      display: flex;
      justify-content: space-around;
      background: #fff;
      border-top: 1px solid #ddd;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      padding: 5px 0;
    }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      font-size: 12px;
      color: #555;
      transition: color 0.3s ease;
      padding: 5px 0;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    .nav-item.active {
      color: var(--primary-color);
      font-weight: bold;
      background: rgba(0, 96, 100, 0.1);
      border-radius: 12px;
    }
    .nav-item i {
      font-size: 24px;
      margin-bottom: 2px;
    }
    .nav-item::after {
      content: "";
      position: absolute;
      width: 200%;
      height: 200%;
      background: rgba(255, 255, 255, 0.3);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      border-radius: 50%;
      transition: transform 0.4s ease-out;
      pointer-events: none;
    }
    .nav-item:active::after {
      transform: translate(-50%, -50%) scale(1);
    }
    /* Sales History Cards */
    .list-container {
      padding: 5px;
    }
    .vente-card {
      background: var(--white);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 12px;
      margin-bottom: 10px;
      font-size: 16px;
      position: relative;
      width: 100%;
    }
    .vente-card p {
      margin-bottom: 6px;
    }
    .vente-card button {
      width: auto;
      padding: 10px 14px;
      font-size: 16px;
      background-color: var(--primary-color);
      color: var(--white);
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      margin-right: 5px;
    }
    .vente-card button:hover {
      background-color: var(--secondary-color);
    }
    .delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      font-size: 22px;
      color: red;
      cursor: pointer;
    }
    .echouee {
      border: 2px solid red;
    }
    .panier-item {
      background: #fafafa;
      border: 1px solid #eee;
      border-radius: var(--border-radius);
      padding: 12px;
      margin-bottom: 8px;
      font-size: 16px;
    }
    /* ===============================
       Interface Menu (Thème Clair)
       =============================== */
       #screen-menu {
        margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color); }


    #screen-menu .menu {
      padding: 15px;
    }
    #screen-menu .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    #screen-menu .header-icons {
      display: flex;
      gap: 15px;
    }
    #screen-menu .profile-section {
      display: flex;
      align-items: center;
      background-color: #fff;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }
    #screen-menu .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: url('https://via.placeholder.com/40') center/cover;
      margin-right: 10px;
    }
    #screen-menu .profile-info div {
      font-weight: bold;
    }
    #screen-menu .shortcuts {
      display: flex;
      overflow-x: auto;
      gap: 10px;
      margin-bottom: 15px;
    }
    #screen-menu .shortcut {
      width: 60px;
      flex-shrink: 0;
      text-align: center;
      font-size: 12px;
      color: #555;
    }
    #screen-menu .shortcut img {
      width: 100%;
      border-radius: 10px;
      height: 60px;
      object-fit: cover;
    }
    #screen-menu .sections {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    #screen-menu .section {
      background-color: #fff;
      padding: 12px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      cursor: pointer;
    }
    #screen-menu .section svg {
      color: #006064;
    }
    /* CSS pour l'écran de recherche d'article */
    #searchProduitInput {
      width: 100%;
      padding: 10px;
      border-radius: var(--border-radius);
      border: 1px solid #ccc;
      margin-bottom: 15px;
    }
    /* Styles ajoutés pour la liste de suggestions */
    .suggestion-list {
      position: absolute;
      background: var(--white);
      border: 1px solid #ccc;
      z-index: 1000;
      max-height: 150px;
      overflow-y: auto;
      width: 100%;
    }
    .suggestion-item {
      padding: 8px 10px;
      cursor: pointer;
    }
    .suggestion-item:hover {
      background: #f0f0f0;
    }
  </style>
  <!-- Styles spécifiques aux suggestions déjà existants -->
  <style>
    .suggestion-list {
      position: absolute;
      background: var(--white);
      border: 1px solid #ccc;
      z-index: 1000;
      max-height: 150px;
      overflow-y: auto;
      width: 100%;
    }
    .suggestion-item {
      padding: 8px 10px;
      cursor: pointer;
    }
    .suggestion-item:hover {
      background: #f0f0f0;
    }

    
    

    
  </style>
</head>
<body>
  <!-- Preloader -->
  <div id="preloader">
    <div class="spinner"></div>
  </div>
  
  <!-- Sale Loader Popup -->
  <div id="saleLoader">
    <div class="loader-content">
      <div class="spinner" style="width:40px; height:40px; border: 6px solid #f3f3f3; border-top: 6px solid var(--primary-color);"></div>
      <p>Enregistrement de la vente...</p>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast"></div>

  <!-- Message de progression pour les téléchargements -->
  <div id="downloadProgress" style="display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); background:var(--primary-color); color:var(--white); padding:10px 20px; border-radius:5px; z-index:3000;"></div>
  
  <div id="app" style="display: none;">
    <!-- Screen 1: Nouvelle Vente - Multi-steps -->
    <section id="screen-vendre" class="screen active">
      <header>
        <!-- Entête retiré selon la demande -->
      </header>
      

      <div id="saleSteps">
        <div class="progress-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <span id="progressText">Étape 1 / 5</span>
        <div class="sale-step active" id="step1">
          <h2>Étape 1 : Ajouter des Articles</h2>
          <form class="vente-form" onsubmit="event.preventDefault();">
            <label for="produit">Article</label>
            <div class="input-container">
              <input type="text" id="produit" placeholder="Rechercher un article" autocomplete="off" />
              <div id="suggestionList" class="suggestion-list"></div>
            </div>
            <label for="prix">Prix Unitaire</label>
            <input type="number" id="prix" placeholder="Prix unitaire" oninput="calculerTotalArticle()" />
            <label for="quantite">Quantité</label>
            <div class="quantity-container">
              <button type="button" onclick="decrementQuantity()">–</button>
              <input type="number" id="quantite" min="1" value="1" oninput="calculerTotalArticle()" />
              <button type="button" onclick="incrementQuantity()">+</button>
            </div>
            <label for="totalArticle">Montant Total</label>
            <input type="number" id="totalArticle" readonly placeholder="Calcul automatique" />
            <button type="button" class="btn-modern" onclick="ajouterArticle()">
              <i data-lucide="shopping-cart"></i> Ajouter Article
            </button>
          </form>
          <button class="btn-modern secondary" onclick="ouvrirPanier()">
            <i data-lucide="shopping-bag"></i> Voir Panier
          </button>
          <div class="step-navigation">
            <button class="btn-modern secondary" onclick="prevStep()">
              <i data-lucide="arrow-left"></i> Retour
            </button>
            <button id="installBtn" style="display: none;">
  📲 Installer l'application
</button>
            <button class="btn-modern" onclick="nextStep()">
              Suivant <i data-lucide="arrow-right"></i>
            </button>
          </div>
        </div>
        <!-- Étape 2 : Informations Client -->
        <div class="sale-step" id="step2">
          <h2>Étape 2 : Informations Client</h2>
          <form class="vente-form" onsubmit="event.preventDefault();">
            <label for="clientNom">Nom du Client</label>
            <div class="input-with-icon">
              <i data-lucide="user"></i>
              <input type="text" id="clientNom" placeholder="Nom du client" required />
            </div>
            <label for="clientNumero">WhatsApp</label>
            <div class="input-with-icon">
              <i data-lucide="phone"></i>
              <input type="text" id="clientNumero" placeholder="Numéro WhatsApp" required />
            </div>
          </form>
          <div class="step-navigation">
            <button class="btn-modern secondary" onclick="prevStep()">
              <i data-lucide="arrow-left"></i> Retour
            </button>
            <button class="btn-modern" onclick="nextStep()">
              Suivant <i data-lucide="arrow-right"></i>
            </button>
          </div>
        </div>
        <!-- Étape 3 : Informations Vendeur -->
        <div class="sale-step" id="step3">
          <h2>Étape 3 : Informations Vendeur</h2>
          <form class="vente-form" onsubmit="event.preventDefault();">
            <label for="vendeurSelect">Vendeur</label>
            <select id="vendeurSelect">
              <!-- Options générées via Firestore -->
            </select>
            <label for="photoFacture">Photo de la facture</label>
            <input type="file" accept="image/*" capture="camera" id="photoFacture" />
            <label for="observationsVendeur">Observations</label>
            <textarea id="observationsVendeur" placeholder="Observations (facultatif)"></textarea>
            <label for="isDelivery">
              <input type="checkbox" id="isDelivery" onchange="toggleDeliveryFields()" /> Vente avec Livraison
            </label>
          </form>
          <div class="step-navigation">
            <button class="btn-modern secondary" onclick="prevStep()">
              <i data-lucide="arrow-left"></i> Retour
            </button>
            <button class="btn-modern" onclick="nextStep()">
              Suivant <i data-lucide="arrow-right"></i>
            </button>
          </div>
        </div>
        <!-- Étape 4 : Informations Livraison -->
        <div class="sale-step" id="step4">
          <h2>Étape 4 : Informations Livraison</h2>
          <form class="vente-form" onsubmit="event.preventDefault();">
            <label for="livreurNom">Nom du Livreur</label>
            <input type="text" id="livreurNom" placeholder="Nom du livreur" />
            <label for="livreurNumero">Numéro du Livreur</label>
            <input type="text" id="livreurNumero" placeholder="Numéro du livreur" />
            <label for="lieuLivraison">Lieu de Livraison</label>
            <input type="text" id="lieuLivraison" placeholder="Lieu de livraison" />
          </form>
          <div class="step-navigation">
            <button class="btn-modern secondary" onclick="prevStep()">
              <i data-lucide="arrow-left"></i> Retour
            </button>
            <button class="btn-modern" onclick="nextStep()">
              Suivant <i data-lucide="arrow-right"></i>
            </button>
          </div>
        </div>
        <!-- Étape 5 : Confirmation -->
        <div class="sale-step" id="step5">
          <h2>Étape 5 : Confirmation</h2>
          <div id="saleRecap">
            <!-- Récapitulatif dynamique de la vente -->
          </div>
          <div class="step-navigation">
            <button class="btn-modern secondary" onclick="prevStep()">
              <i data-lucide="arrow-left"></i> Retour
            </button>
            <button class="btn-modern" id="btnValider" onclick="if(confirm(getValidationMessage())) { validerVente(); }">
              Confirmer la Vente
            </button>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Screen 2: Livraisons -->
    <section id="screen-livraisons" class="screen">
      <header>
        <h1>Historique des Livraisons</h1>
        <div class="timestamp">
          <span id="dateLivraison"></span>
        </div>
      </header>
      <div id="livraisonsContainer" class="list-container"></div>
    </section>
    
    <!-- Screen 3: Historique des Ventes -->
    <section id="screen-historique" class="screen">
      <header>
        <h1>Historique des Ventes</h1>
        <div class="timestamp">
          <span id="dateAfficheHist"></span>
        </div>
      </header>

      <div id="history-filters" style="padding:10px; text-align:center;">
        <input type="date" id="filterHistoryDate" onchange="filterHistory()" />
        <div id="totalPhonesSold" style="margin-top:10px; font-weight:bold;"></div>
      </div>
      <div id="ventesContainer" class="list-container"></div>
    </section>

    <script>
      // Initialisation de la date par défaut et appel automatique du filtrage à l'ouverture de la page
      window.addEventListener("load", () => {
        const todayISO = new Date().toISOString().split("T")[0];
        document.getElementById("filterHistoryDate").value = todayISO;
        filterHistory(); // Charge automatiquement les ventes d'aujourd'hui
      });
    
      // Fonction pour filtrer l'historique des ventes en fonction de la date sélectionnée
      function filterHistory() {
        const dateInput = document.getElementById("filterHistoryDate").value;
        if (!dateInput) {
          console.warn("Aucune date sélectionnée");
          return;
        }
        // Convertir la date ISO en format "fr-FR" (par exemple "19/03/2025")
        const selectedDate = new Date(dateInput).toLocaleDateString("fr-FR");
    
        dbFirestore.collection("ventes")
          .where("dateVente", "==", selectedDate)
          .get()
          .then(querySnapshot => {
            let totalPhones = 0;
            const salesList = [];
            
            querySnapshot.forEach(doc => {
              const sale = doc.data();
              sale.id = doc.id;
              salesList.push(sale);
              
              // Calculer le total des téléphones vendus.
              // Si l'article ne contient pas de propriété "category", on suppose que c'est un téléphone.
              if (sale.items && Array.isArray(sale.items)) {
                sale.items.forEach(item => {
                  if (!item.category || item.category.toLowerCase() === "telephones") {
                    totalPhones += parseInt(item.quantite) || 0;
                  }
                });
              }
            });
            
            // Met à jour l'affichage du nombre total de téléphones vendus
            document.getElementById("totalPhonesSold").innerText =
              "Total Téléphones vendus : " + totalPhones;
            
            // Affiche l'historique des ventes
            displaySalesHistory(salesList);
          })
          .catch(err => {
            console.error("Erreur lors du filtrage des ventes par date:", err);
          });
      }
    
      // Fonction pour afficher l'historique des ventes dans la section appropriée
      function displaySalesHistory(salesList) {
        const container = document.getElementById("ventesContainer");
        container.innerHTML = "";
        
        if (salesList.length === 0) {
          container.innerHTML = `
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 250px;">
              <i data-lucide="smile" style="width: 80px; height: 80px; color: #ccc;"></i>
              <p style="font-size: 18px; color: #888; margin-top: 20px;">Aucune vente enregistrée…</p>
            </div>`;
          lucide.createIcons();
          return;
        }
        
        salesList.forEach(sale => {
          const card = document.createElement("div");
          card.className = "vente-card";
          card.innerHTML = `
            <p><strong>${sale.clientNom}</strong> (${sale.clientNumero})</p>
            <p>Vendeur : ${sale.vendeur}</p>
            <p>Articles : ${sale.items ? sale.items.length : 0}</p>
            <p>Total : ${sale.overallTotal}</p>
            <button onclick="ouvrirDetails('${sale.id}')">Détails</button>
            <button class="delete-btn" onclick="demanderAnnulation('${sale.id}')" title="Annuler la vente">×</button>
          `;
          container.appendChild(card);
        });
        // Recharge les icônes Lucide
        lucide.createIcons();
      }
    </script>
    

    <!-- Screen 4: Stock -->
    <section id="screen-stock" class="screen">
      <header>
        <h1>Stock</h1>
        <div class="timestamp">
          <span id="dateStock"></span>
        </div>
      </header>
      <div id="stock-home">
        <div class="summary" style="padding: 15px; background: var(--white); border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 15px;">
          <p><strong>Total Téléphones :</strong> <span id="total-telephones">0</span></p>
          <p><strong>Total Accessoires :</strong> <span id="total-accessoires">0</span></p>
        </div>
        <div class="card-buttons" style="display: flex; flex-direction: column; gap: 10px;">
          <button class="btn-modern" onclick="showStockCategory('telephones')">
            <i data-lucide="package"></i> Téléphones
          </button>
          <button class="btn-modern" onclick="showStockCategory('accessoires')">
            <i data-lucide="headphones"></i> Accessoires
          </button>
        </div>
      </div>
      <div id="stock-category" style="display: none;">
        <button class="btn-modern secondary" onclick="backToStockHome()">
          <i data-lucide="arrow-left"></i> Retour
        </button>
        <input type="text" id="search-category" placeholder="Rechercher..." style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: var(--border-radius);" oninput="filterStockCategory()">
        <div id="category-container" class="cards-container"></div>
      </div>
    </section>

    <!-- Screen 5: Entrée de Stock -->
    <section id="screen-entree-stock" class="screen">
      <header>
        <button class="back-btn" onclick="window.location.hash='parametres'">← Retour</button>
        <h1>Nouvelle Entrée de Stock</h1>
      </header>
      <div class="form-section">
        <h2>Ajouter un Article</h2>
        <form class="vente-form" onsubmit="event.preventDefault(); ajouterEntreeStock();">
          <label for="categorieEntree">Catégorie</label>
          <select id="categorieEntree">
            <option value="telephones">Téléphones</option>
            <option value="accessoires">Accessoires</option>
          </select>
          <label for="produitEntree">Article</label>
          <div class="input-with-icon">
            <i data-lucide="package"></i>
            <input type="text" id="produitEntree" placeholder="Rechercher un article" autocomplete="off" />
            <div id="suggestionListEntree" class="suggestion-list"></div>
          </div>
          <label for="prixEntree">Prix d'Achat Unitaire</label>
          <div class="input-with-icon">
            <i data-lucide="dollar-sign"></i>
            <input type="number" id="prixEntree" placeholder="Prix d'achat unitaire" oninput="calculerTotalEntree()" />
          </div>
          <label for="quantiteEntree">Quantité</label>
          <input type="number" id="quantiteEntree" min="1" value="1" oninput="calculerTotalEntree()" />
          <label for="totalEntree">Montant Total</label>
          <div class="input-with-icon">
            <i data-lucide="calculator"></i>
            <input type="number" id="totalEntree" readonly placeholder="Calcul automatique" />
          </div>
          <button class="btn-modern" type="submit">Ajouter Entrée</button>
        </form>
      </div>
    </section>

    <!-- Section Avance de Paiement -->
<section id="screen-advance" class="screen">
  <header>
    <button class="back-btn" onclick="window.location.hash='menu'">
      <i data-lucide="arrow-left"></i> Retour
    </button>
    <h1>Enregistrer une Avance</h1>
  </header>
  <div class="form-section">
    <h2>Avance de Paiement</h2>
    <form id="formAdvance" onsubmit="event.preventDefault(); enregistrerAvance();">
      <label for="saleId">ID de la Vente</label>
      <input type="text" id="saleId" placeholder="Entrez l'ID de la vente" required />

      <label for="avanceAmount">Montant de l'Avance (FCFA)</label>
      <input type="number" id="avanceAmount" placeholder="Montant de l'avance" required />

      <label for="modePaiement">Mode de Paiement</label>
      <select id="modePaiement">
        <option value="espèces">Espèces</option>
        <option value="carte">Carte bancaire</option>
        <option value="virement">Virement</option>
      </select>

      <button type="submit" class="btn-modern">Enregistrer l'Avance</button>
    </form>
  </div>
</section>

<!-- Script pour la gestion des avances -->
<script>
  /**
   * Fonction pour enregistrer une avance de paiement sur une vente.
   * Elle récupère le document de vente par son ID, vérifie le solde restant,
   * ajoute le paiement dans la sous-collection "paiements" puis met à jour le document.
   */
  function enregistrerAvance() {
    const saleId = document.getElementById("saleId").value.trim();
    const avanceAmount = parseFloat(document.getElementById("avanceAmount").value);
    const modePaiement = document.getElementById("modePaiement").value;

    if (!saleId) {
      alert("Veuillez saisir l'ID de la vente.");
      return;
    }
    if (isNaN(avanceAmount) || avanceAmount <= 0) {
      alert("Veuillez saisir un montant d'avance valide.");
      return;
    }

    // Récupérer le document de vente dans la collection "ventes"
    const saleRef = dbFirestore.collection("ventes").doc(saleId);
    saleRef.get().then(doc => {
      if (!doc.exists) {
        alert("Vente introuvée !");
        return;
      }
      const saleData = doc.data();
      // Si la vente est déjà réglée, on ne peut pas enregistrer d'avance
      if (saleData.status === "complet") {
        alert("La vente est déjà réglée en totalité.");
        return;
      }
      // Calculer le solde restant (en utilisant le champ remainingBalance si présent)
      const remaining = saleData.remainingBalance !== undefined
                        ? saleData.remainingBalance
                        : saleData.totalAmount - (saleData.paidAmount || 0);
      if (avanceAmount > remaining) {
        alert("Le montant d'avance dépasse le solde restant (" + remaining.toLocaleString() + " FCFA).");
        return;
      }
      // Créer un document de paiement dans la sous-collection "paiements"
      const paiement = {
        montant: avanceAmount,
        datePaiement: new Date().toISOString(),
        modePaiement: modePaiement
      };
      saleRef.collection("paiements").add(paiement)
        .then(() => {
          // Mettre à jour le document de vente avec le nouveau cumul et recalculer le solde
          const newPaidAmount = (saleData.paidAmount || 0) + avanceAmount;
          const newRemaining = saleData.totalAmount - newPaidAmount;
          const newStatus = newRemaining <= 0 ? "complet" : "avance partielle";
          return saleRef.update({
            paidAmount: newPaidAmount,
            remainingBalance: newRemaining,
            status: newStatus
          });
        })
        .then(() => {
          alert("Avance enregistrée avec succès !");
          document.getElementById("formAdvance").reset();
        })
        .catch(err => {
          console.error("Erreur lors de l'enregistrement de l'avance :", err);
          alert("Erreur lors de l'enregistrement de l'avance : " + err.message);
        });
    })
    .catch(error => {
      console.error("Erreur lors de la récupération de la vente :", error);
      alert("Erreur lors de la récupération de la vente : " + error.message);
    });
  }
</script>


    <!-- Screen 6: Menu Principal (Thème Clair) -->
    <section id="screen-menu" class="screen">
      <div class="menu">
        <!-- En-tête inchangé -->
        <div class="header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <div id="current-time-menu" style="font-size: 16px; font-weight: bold; color: #006064;">9:40</div>
          <div class="header-icons" style="display: flex; gap: 15px;">
            <i data-lucide="camera"></i>
            <i data-lucide="message-circle"></i>
            <i data-lucide="bell"></i>
            <i data-lucide="user-circle"></i>
          </div>
        </div>
        <!-- Section Profil inchangée -->
        <div class="profile-section">
          <div class="profile-pic" style="background: url('https://via.placeholder.com/40') center/cover;"></div>
          <div class="profile-info">
            <div>Zidane </div>
          </div>
          <i data-lucide="chevron-down"></i>
        </div>
        <!-- Sections du menu adaptées avec nouvelles fonctionnalités -->
        <div class="sections">
          <div class="section" onclick="window.location.hash='clients'">
            <i data-lucide="users"></i>
            Clients
          </div>
          <div class="section" onclick="window.location.hash='vendeurs'">
            <i data-lucide="users"></i>
            Gestion des Vendeurs
          </div>
          <div class="section" onclick="window.location.hash='rapports'">
            <i data-lucide="file-text"></i>
            Rapports & Statistiques
          </div>

          <div class="section" onclick="window.location.hash='approvisionnement'">
            <i data-lucide="archive"></i>
            Approvisionnement
          </div>          
          <!-- "Base Clients" section supprimée -->
          <div class="section" onclick="window.location.hash='notifications'">
            <i data-lucide="bell-ring"></i>
            Notifications
          </div>
          <div class="section" onclick="window.location.hash='tresorerie'">
            <i data-lucide="dollar-sign"></i>
            Trésorerie
          </div>
          <div class="section" onclick="window.location.hash='depenses'">
            <i data-lucide="file-minus"></i>
            Dépenses
          </div>
          <!-- Dans la section du Menu, par exemple dans la div contenant les sections -->
          <div class="section" onclick="window.location.hash='advance'">
            <i data-lucide="dollar-sign"></i>
            Avance
          </div>
          <div class="section" onclick="window.location.hash='repertoire-imei'">
            <i data-lucide="list"></i>
            Répertoire d'IMEI
          </div>

          <div class="section" onclick="window.location.hash='faq'">
            <i data-lucide="help-circle"></i>
            FAQ
          </div>
          <div class="section" onclick="window.location.hash='parametres'">
            <i data-lucide="settings"></i>
            Paramètres
          </div>
          <div class="section" onclick="deconnexion()">
            <i data-lucide="log-out"></i>
            Déconnexion
          </div>
        </div>
      </div>
    </section>
    
    <!-- Nouvel écran dédié à la recherche d'article -->
    <section id="screen-search-article" class="screen">
      <header>
        <button class="back-btn" onclick="window.location.hash='vendre'">
          <i data-lucide="arrow-left"></i>
        </button>
        <h1>Rechercher un Article</h1>
      </header>
      <div style="padding:15px;">
        <input type="text" id="searchProduitInput" placeholder="Rechercher un article..." />
        <div id="searchResults" class="cards-container"></div>
      </div>
    </section>

    <section id="screen-repertoire-imei" class="screen">
      <header>
        <button class="back-btn" onclick="window.location.hash='menu'">
          <i data-lucide="arrow-left"></i>
        </button>
        <h1>Répertoire d'IMEI</h1>
      </header>
      <div style="padding: 15px;">
        <!-- Ajoutez ici le contenu du répertoire d'IMEI -->
        <p>Liste des IMEI...</p>
      </div>
    </section>

    <!-- Nouvel écran : Trésorerie - Inspiré de Qonto -->
<!-- Screen: Trésorerie -->
<!-- Nouvel écran : Trésorerie - Inspiré de Qonto -->
<section id="screen-tresorerie" class="screen">
  <style>
    :root {
      --primary-color: #6D5DFD;
      --background-color: #F5F5FA;
      --card-bg: #ffffff;
      --text-color: #333;
      --border-radius: 12px;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
    }
    .container {
      padding: 15px;
    }
    .balance-card {
      background-color: var(--card-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 15px;
      text-align: center;
    }
    .balance-card h1 {
      margin: 0;
      font-size: 32px;
    }
    .section-title {
      font-size: 18px;
      font-weight: bold;
      margin: 15px 0 10px;
    }
    .history-list {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      overflow: hidden;
      margin-bottom: 15px;
    }
    .history-item {
      padding: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #EEE;
    }
    .history-item:last-child {
      border-bottom: none;
    }
    .amount {
      font-weight: bold;
    }
    .in { color: #28a745; }
    .out { color: #dc3545; }
    .btn {
      background-color: var(--primary-color);
      color: white;
      padding: 12px;
      text-align: center;
      border-radius: var(--border-radius);
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      border: none;
      margin-top: 10px;
    }
  </style>

  <div class="container">
    <!-- Carte de solde -->
    <div class="balance-card">
      <h1 id="balance-sold">XOF 0</h1>
      <p>Solde actuel</p>
      <p style="color:#666;">Comparé à hier : <strong id="balance-change" style="color:#28a745">+0%</strong></p>
    </div>

    <!-- Total des entrées d'aujourd'hui -->
    <div class="section-title">Entrées d'aujourd'hui</div>
    <div class="history-list" id="entrees-list">
      <div class="history-item">
        <div class="info">Total Entrées</div>
        <div class="amount in" id="entrees-today">+XOF 0</div>
        <button class="btn" onclick="window.location.hash='historique'">Voir plus</button>
      </div>
    </div>

    <!-- Total des dépenses d'aujourd'hui -->
    <div class="section-title">Dépenses d'aujourd'hui</div>
    <div class="history-list" id="depenses-list">
      <div class="history-item">
        <div class="info">Total Dépenses</div>
        <div class="amount out" id="depenses-today">-XOF 0</div>
        <button class="btn" onclick="window.location.hash='depenses'">Voir plus</button>
      </div>
    </div>
  </div>

  <script>
    // Appel initial pour mettre à jour l'affichage des totaux et du solde
    updateBalanceDisplay();
  </script>
</section>

    <!-- Screen: Dépenses -->
<!-- Screen: Dépenses -->
<section id="screen-depenses" class="screen">
  <style>
    .depenses-container {
      padding: 15px;
    }
    .depenses-summary {
      background: var(--white);
      box-shadow: var(--shadow);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 15px;
      text-align: center;
    }
    .summary-item h2 {
      margin-bottom: 5px;
      color: var(--primary-color);
    }
    .summary-item p {
      color: #666;
      font-size: 14px;
    }
    .actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }
    .btn-modern.secondary {
      background-color: #E4E6EB;
      color: black;
      box-shadow: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-modern.secondary i {
      font-size: 20px;
    }
    .section-title {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 18px;
      color: var(--text-color);
    }
    .history-list .history-item {
      padding: 12px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .history-item:last-child {
      border-bottom: none;
    }
    .history-icon {
      margin-right: 8px;
    }
    /* Bouton Retour style Facebook */
    .back-btn-fb {
      width: 40px;
      height: 40px;
      border: none;
      background: none;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      border-radius: 50%;
      cursor: pointer;
      overflow: hidden;
      outline: none;
    }
    .back-btn-fb i {
      font-size: 24px;
      color: var(--primary-color);
    }
    .back-btn-fb::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 200%;
      height: 200%;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      transform: translate(-50%, -50%) scale(0);
      transition: transform 0.3s ease-out;
      pointer-events: none;
    }
    .back-btn-fb:active::after {
      transform: translate(-50%, -50%) scale(1);
    }
  </style>

  <header>
    <button class="back-btn-fb" onclick="window.location.hash='menu'">
      <i data-lucide="arrow-left"></i>
    </button>
    <h1>Dépenses</h1>
  </header>

  <div class="depenses-container">
    <div class="actions">
      <button class="btn-modern secondary" onclick="window.location.hash='depense-fonctionnelle'">
        <i data-lucide="file-minus"></i> Dépense Fonctionnelle
      </button>
      <button id="btnDepensePapa" class="btn-modern secondary" onclick="window.location.hash='depense-papa'">
        <i data-lucide="user-minus"></i> Dépense Papa
      </button>          
      <button class="btn-modern secondary" onclick="window.location.hash='remboursement-papa'">
        <i data-lucide="user-check"></i> Remboursement
      </button>
    </div>

    <div class="section-title">Historique récent</div>
    <div id="recent-depenses" class="history-list">
      <p style="text-align:center;">Chargement en cours...</p>
    </div>

    <button class="btn-modern secondary" onclick="exporterDepenses()">
      <i data-lucide="download"></i> Exporter PDF
    </button>
  </div>

  <script>
    /**
     * Récupère et affiche la somme de toutes les dépenses (type "depense" ou "papa")
     * pour la journée en cours, puis met à jour le champ #depenses-today.
     */
    function afficherDepensesAujourdhui() {
      const today = new Date();
      // On définit le début et la fin du jour en millisecondes
      const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
      const endOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1).getTime() - 1;

      dbFirestore.collection("depenses")
        .where("timestamp", ">=", startOfToday)
        .where("timestamp", "<=", endOfToday)
        .get()
        .then(snapshot => {
          let totalDepenses = 0;
          snapshot.forEach(doc => {
            const data = doc.data();
            // On somme uniquement les dépenses de type "depense" ou "papa"
            // (si vous n'avez pas de type, retirez simplement le if)
            if (data.type === "depense" || data.type === "papa" || !data.type) {
              totalDepenses += parseFloat(data.montant) || 0;
            }
          });
          // Mise à jour de l'affichage
          document.getElementById("depenses-today-dep").textContent = `${totalDepenses.toLocaleString()} FCFA`;
        })
        .catch(error => {
          console.error("Erreur lors de la récupération des dépenses du jour : " + error.message);
        });
    }

    /**
     * Récupère l'ensemble des documents de "depenses" et "remboursements",
     * les fusionne, puis affiche un historique récent.
     */
     function chargerHistoriqueDepenses() {
  const depensesPromise = dbFirestore.collection("depenses")
    .orderBy("timestamp", "desc")
    .get()
    .then(snapshot => {
      let depensesArray = [];
      snapshot.forEach(doc => {
        let d = doc.data();
        // On utilise "depense" par défaut si aucun type n'est défini
        d.type = d.type || "depense";
        depensesArray.push(d);
      });
      return depensesArray;
    });

  const remboursementsPromise = dbFirestore.collection("remboursements")
    .orderBy("timestamp", "desc")
    .get()
    .then(snapshot => {
      let remboursementsArray = [];
      snapshot.forEach(doc => {
        let r = doc.data();
        r.type = "remboursement";
        remboursementsArray.push(r);
      });
      return remboursementsArray;
    });

  Promise.all([depensesPromise, remboursementsPromise])
    .then(([depenses, remboursements]) => {
      let combined = depenses.concat(remboursements);
      combined.sort((a, b) => b.timestamp - a.timestamp);

      const container = document.getElementById("recent-depenses");
      container.innerHTML = "";

      combined.forEach(item => {
        let iconHtml = "";
        let montantDisplay = "";
        
        // On considère "depense fonctionnelle" comme une dépense classique pour l'affichage
        if (item.type === "depense" ||
            item.type === "depense fonctionnelle" ||
            item.type === "papa") {
          iconHtml = (item.type === "papa") 
            ? `<i data-lucide="user-minus"></i>` 
            : `<i data-lucide="file-minus"></i>`;
          montantDisplay = `<div class="amount out">-XOF ${parseFloat(item.montant).toLocaleString()}</div>`;
        } else if (item.type === "remboursement") {
          iconHtml = `<i data-lucide="user-check"></i>`;
          montantDisplay = `<div class="amount in">+XOF ${parseFloat(item.montant).toLocaleString()}</div>`;
        }

        container.innerHTML += `
          <div class="history-item" style="display: flex; align-items: center;">
            <div class="depense-icon" style="margin-right: 10px;">
              ${iconHtml}
            </div>
            <div class="depense-info" style="flex-grow: 1;">
              ${item.description || "Aucune description"}<br>
              <small style="color:#888;">${new Date(item.timestamp).toLocaleString()}</small>
            </div>
            ${montantDisplay}
          </div>
        `;
      });
      // Recharge les icônes Lucide
      lucide.createIcons();
    })
    .catch(error => console.error("Erreur lors du chargement des dépenses et remboursements :", error));
}


    /**
     * On met à jour le total des dépenses du jour + l'historique
     * dès que l'écran "#depenses" est affiché.
     */
    window.addEventListener('hashchange', function(){
      if(window.location.hash === '#depenses') {
        afficherDepensesAujourdhui();    // ← pour afficher la somme des dépenses du jour
        chargerHistoriqueDepenses();     // ← pour lister toutes les dépenses/remboursements
      }
    });
    // Si on arrive directement sur "#depenses" après chargement...
    if(window.location.hash === '#depenses') {
      afficherDepensesAujourdhui();
      chargerHistoriqueDepenses();
    }
  </script>
</section>

<!-- ===== Début de la section Rapports & Statistiques ===== -->
<section id="screen-rapports" class="screen">
  <header class="rapport-header">
    <button class="btn-back" onclick="window.location.hash='menu'">
      <i data-lucide="arrow-left"></i>
    </button>
    <h1>Rapports & Statistiques</h1>
    <button class="btn-refresh" onclick="updateRapports()">
      <i data-lucide="rotate-ccw"></i> Actualiser
    </button>
  </header>

  <!-- Filtres avancés : Sélection d'une journée ou d'une période -->
  <div class="filter-container">
    <label for="filterDate">Journée :</label>
    <input type="date" id="filterDate" onchange="updateRapports()" />
    <span style="margin: 0 10px;">ou</span>
    <label for="startDate">Du :</label>
    <input type="date" id="startDate" onchange="updateRapports()" />
    <label for="endDate">Au :</label>
    <input type="date" id="endDate" onchange="updateRapports()" />
  </div>

  <div class="reports-container">
    <!-- Carte Résumé des Ventes -->
    <div class="report-card">
      <h2>Résumé des Ventes</h2>
      <ul>
        <li><span>Nombre total de ventes :</span> <span id="total-ventes">0</span></li>
        <li><span>Chiffre d'affaires :</span> <span id="chiffre-affaires">0 FCFA</span></li>
        <li><span>Moyenne par vente :</span> <span id="moyenne-vente">0 FCFA</span></li>
        <li><span>Répartition Ventes/Livraisons :</span> <span id="ventes-repartition">0 / 0</span></li>
      </ul>
    </div>

    <!-- Carte Profit Global dans la section Rapports -->
<div class="report-card" onclick="window.location.hash='profit'">
  <h2>Profit Global</h2>
  <ul>
    <li><span>Profit Total :</span> <span id="profit-total">0 FCFA</span></li>
    <li><span>Profit Moyen par Vente :</span> <span id="profit-moyen">0 FCFA</span></li>
  </ul>
</div>

    <!-- Carte Analyse des Livraisons -->
    <div class="report-card">
      <h2>Analyse des Livraisons</h2>
      <ul>
        <li><span>Total livraisons :</span> <span id="total-livraisons">0</span></li>
        <li><span>En cours :</span> <span id="livraisons-en-cours">0</span></li>
        <li><span>Réussies :</span> <span id="livraisons-reussies">0</span></li>
        <li><span>Échouées :</span> <span id="livraisons-echouees">0</span></li>
      </ul>
    </div>
    <!-- Carte Synthèse du Stock -->
    <div class="report-card">
      <h2>Synthèse du Stock</h2>
      <ul>
        <li><span>Téléphones :</span> <span id="rapport-total-telephones">0</span></li>
        <li><span>Accessoires :</span> <span id="rapport-total-accessoires">0</span></li>
        <li><span>Valeur du stock :</span> <span id="valeur-stock">0 FCFA</span></li>
      </ul>
    </div>
    <!-- Carte Détail Dépenses -->
    <div class="report-card">
      <h2>Détail Dépenses</h2>
      <ul>
        <li><span>Dépenses Fonctionnelles :</span> <span id="depenses-fonctionnelles">0 FCFA</span></li>
        <li><span>Dépenses "Papa" :</span> <span id="depenses-papa">0 FCFA</span></li>
        <li><span>Transactions :</span> <span id="nombre-transactions">0</span></li>
        <li><span>Moyenne dépense :</span> <span id="moyenne-depense">0 FCFA</span></li>
      </ul>
    </div>
    <!-- Carte Performance Vendeurs -->
    <div class="report-card">
      <h2>Performance Vendeurs</h2>
      <ul>
        <li><span>CA par vendeur :</span> <span id="ca-par-vendeur">-</span></li>
        <li><span>Ventes par vendeur :</span> <span id="ventes-par-vendeur">-</span></li>
      </ul>
    </div>
    <!-- Carte Indicateurs Clés -->
    <div class="report-card">
      <h2>Indicateurs Clés</h2>
      <ul>
        <li><span>Comparaison jour/semaine :</span> <span id="comparaison-temporelle">-</span></li>
        <li><span>Évolution stocks :</span> <span id="evolution-stocks">-</span></li>
        <li><span>KPIs globaux :</span> <span id="kpi-globaux">-</span></li>
      </ul>
    </div>
  </div>

  <!-- Section Graphique : Graphique de tendance des ventes -->
  <div class="chart-container">
    <h2>Tendance des Ventes</h2>
    <canvas id="salesChart"></canvas>
  </div>
</section>

<!-- ===== Styles CSS pour la section Rapports & Statistiques ===== -->
<style>
  /* Fond et structure générale */
  #screen-rapports {
    background-color: #ffffff;
    padding: 20px;
    min-height: calc(100vh - 60px);
    font-family: 'Roboto', sans-serif;
  }
  /* En-tête de la section */
  .rapport-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-bottom: 10px;
    border-bottom: 1px solid #e0e0e0;
  }
  .rapport-header h1 {
    font-size: 24px;
    color: #333;
    margin: 0;
  }
  /* Boutons plats, arrondis, avec couleurs neutres et accents */
  .btn-back,
  .btn-refresh {
    background-color: #f2f2f2;
    border: none;
    border-radius: 25px;
    padding: 8px 12px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .btn-back:hover,
  .btn-refresh:hover {
    background-color: #e0e0e0;
  }
  /* Filtres avancés */
  .filter-container {
    margin-top: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 16px;
  }
  .filter-container label {
    font-weight: 500;
    color: #333;
  }
  .filter-container input[type="date"] {
    padding: 6px 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 16px;
  }
  /* Grille de cartes pour les rapports */
  .reports-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }
  /* Style des cartes de rapport */
  .report-card {
    background-color: #fff;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid #f0f0f0;
    transition: box-shadow 0.3s ease;
  }
  .report-card:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  }
  /* Titres des cartes */
  .report-card h2 {
    font-size: 20px;
    color: #006064;
    margin-bottom: 15px;
    border-bottom: 2px solid #006064;
    padding-bottom: 8px;
  }
  /* Listes des indicateurs */
  .report-card ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .report-card ul li {
    display: flex;
    justify-content: space-between;
    font-size: 16px;
    color: #555;
    margin-bottom: 10px;
  }
  .report-card ul li span:first-child {
    font-weight: 500;
    color: #333;
  }
  .report-card ul li span:last-child {
    font-weight: bold;
    color: #000;
  }
  /* Section graphique */
  .chart-container {
    margin-top: 30px;
    background-color: #fff;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid #f0f0f0;
  }
  .chart-container h2 {
    font-size: 20px;
    color: #006064;
    margin-bottom: 15px;
    text-align: center;
  }
  /* Responsive */
  @media (max-width: 480px) {
    #screen-rapports {
      padding: 15px;
    }
    .report-card {
      padding: 15px;
    }
    .report-card h2 {
      font-size: 18px;
    }
    .report-card ul li {
      font-size: 14px;
    }
  }
</style>

<!-- ===== Intégration de Chart.js pour les graphiques ===== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ===== Script JavaScript pour mettre à jour les rapports et le graphique ===== -->
<script>
  function updateRapports() {
    // Récupérer les valeurs des filtres
    const filterDate = document.getElementById("filterDate").value;
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;

    // Fonction de filtrage : si une période est renseignée (startDate et endDate),
    // on filtre par période. Sinon, on utilise filterDate (jour unique)
    const filterByDate = (sale) => {
      if (startDate && endDate) {
        const saleDate = new Date(sale.timestamp);
        const start = new Date(startDate);
        const end = new Date(endDate);
        end.setHours(23, 59, 59, 999);
        return saleDate >= start && saleDate <= end;
      } else if (filterDate) {
        return sale.dateVente === new Date(filterDate).toLocaleDateString("fr-FR");
      }
      return true;
    };

    // Mise à jour du résumé des ventes
    getSalesForTodayFirestore().then(sales => {
      sales = sales.filter(filterByDate);
      const totalVentes = sales.length;
      const chiffreAffaires = sales.reduce((sum, sale) => sum + (parseFloat(sale.overallTotal) || 0), 0);
      const moyenneVente = totalVentes > 0 ? chiffreAffaires / totalVentes : 0;
      const ventesClassiques = sales.filter(sale => !sale.isDelivery || (sale.isDelivery && sale.convertedToSale)).length;
      const livraisons = sales.filter(sale => sale.isDelivery && !sale.convertedToSale).length;
      document.getElementById("total-ventes").textContent = totalVentes;
      document.getElementById("chiffre-affaires").textContent = chiffreAffaires.toLocaleString() + " FCFA";
      document.getElementById("moyenne-vente").textContent = moyenneVente.toLocaleString() + " FCFA";
      document.getElementById("ventes-repartition").textContent = ventesClassiques + " / " + livraisons;
      
      // Mise à jour du graphique des ventes
      updateSalesChart(sales);
        // Calcul du profit global à l'intérieur du même bloc
      let totalProfit = 0;
      sales.forEach(sale => {
        totalProfit += parseFloat(sale.totalProfit) || 0;
      });
      const profitMoyen = totalVentes > 0 ? totalProfit / totalVentes : 0;
      document.getElementById("profit-total").textContent = totalProfit.toLocaleString() + " FCFA";
      document.getElementById("profit-moyen").textContent = profitMoyen.toLocaleString() + " FCFA";
      
    });

    // Mise à jour de l'analyse des livraisons
    getSalesForTodayFirestore().then(sales => {
      sales = sales.filter(filterByDate);
      const livraisonsSales = sales.filter(sale => sale.isDelivery);
      const totalLivraisons = livraisonsSales.length;
      const enCours = livraisonsSales.filter(sale => sale.deliveryStatus === "en cours").length;
      const reussies = livraisonsSales.filter(sale => sale.deliveryStatus === "réussie").length;
      const echouees = livraisonsSales.filter(sale => sale.deliveryStatus === "échouée").length;
      document.getElementById("total-livraisons").textContent = totalLivraisons;
      document.getElementById("livraisons-en-cours").textContent = enCours;
      document.getElementById("livraisons-reussies").textContent = reussies;
      document.getElementById("livraisons-echouees").textContent = echouees;
    });

    // Mise à jour de la synthèse du stock (indépendante du filtre de date)
    getAllStockFirestore().then(stocks => {
      const totalTelephones = stocks.filter(s => s.category === "telephones").reduce((sum, s) => sum + s.stock, 0);
      const totalAccessoires = stocks.filter(s => s.category === "accessoires").reduce((sum, s) => sum + s.stock, 0);
      const valeurStock = stocks.reduce((sum, s) => sum + (s.stock * s.price), 0);
      document.getElementById("rapport-total-telephones").textContent = totalTelephones;
      document.getElementById("rapport-total-accessoires").textContent = totalAccessoires;
      document.getElementById("valeur-stock").textContent = valeurStock.toLocaleString() + " FCFA";
    });

    // Mise à jour du détail des dépenses
    dbFirestore.collection("depenses").get().then(snapshot => {
      let depenseFonctionnelle = 0, depensePapa = 0, transactions = 0;
      snapshot.forEach(doc => {
        const data = doc.data();
        const montant = parseFloat(data.montant) || 0;
        transactions++;
        if (data.type === "papa") {
          depensePapa += montant;
        } else {
          depenseFonctionnelle += montant;
        }
      });
      document.getElementById("depenses-fonctionnelles").textContent = depenseFonctionnelle.toLocaleString() + " FCFA";
      document.getElementById("depenses-papa").textContent = depensePapa.toLocaleString() + " FCFA";
      document.getElementById("nombre-transactions").textContent = transactions;
      const moyenneDepense = transactions > 0 ? (depenseFonctionnelle + depensePapa) / transactions : 0;
      document.getElementById("moyenne-depense").textContent = moyenneDepense.toLocaleString() + " FCFA";
    });

    // Mise à jour de la performance des vendeurs
    getSalesForTodayFirestore().then(sales => {
      sales = sales.filter(filterByDate);
      const caParVendeur = {};
      const ventesParVendeur = {};
      sales.forEach(sale => {
        const vendeur = sale.vendeur || "Inconnu";
        caParVendeur[vendeur] = (caParVendeur[vendeur] || 0) + (parseFloat(sale.overallTotal) || 0);
        ventesParVendeur[vendeur] = (ventesParVendeur[vendeur] || 0) + 1;
      });
      document.getElementById("ca-par-vendeur").textContent = JSON.stringify(caParVendeur);
      document.getElementById("ventes-par-vendeur").textContent = JSON.stringify(ventesParVendeur);
    });

    // Mise à jour des indicateurs clés
    document.getElementById("comparaison-temporelle").textContent = "À implémenter";
    document.getElementById("evolution-stocks").textContent = "À implémenter";
    document.getElementById("kpi-globaux").textContent = "À implémenter";
  }

  // Fonction pour créer ou mettre à jour le graphique des ventes
  let salesChart;
  function updateSalesChart(salesData) {
    const ventesParHeure = new Array(24).fill(0);
    salesData.forEach(sale => {
      const heure = new Date(sale.timestamp).getHours();
      ventesParHeure[heure]++;
    });
    const labels = ventesParHeure.map((_, index) => index + "h");

    if(salesChart) {
      salesChart.data.labels = labels;
      salesChart.data.datasets[0].data = ventesParHeure;
      salesChart.update();
    } else {
      const ctx = document.getElementById('salesChart').getContext('2d');
      salesChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Ventes par heure',
            data: ventesParHeure,
            backgroundColor: 'rgba(0, 96, 100, 0.2)',
            borderColor: 'rgba(0, 96, 100, 1)',
            borderWidth: 2,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { display: true },
            y: { display: true, beginAtZero: true }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }
  }
</script>
<!-- ===== Fin de la section Rapports & Statistiques ===== -->

<!-- Screen: Profit -->
<section id="screen-profit" class="screen">
  <header class="rapport-header">
    <button class="btn-back" onclick="window.location.hash='rapports'">
      <i data-lucide="arrow-left"></i>
    </button>
    <h1>Détails du Profit</h1>
  </header>
  <div class="container">
    <!-- Profit Moyen par Vente -->
    <div class="report-card">
      <h2>Profit Moyen par Vente</h2>
      <p id="detail-profit-moyen">0 FCFA</p>
    </div>
    <!-- Profit par Catégorie -->
    <div class="report-card">
      <h2>Profit par Catégorie</h2>
      <ul id="profit-par-categorie">
        <!-- Exemples : Téléphones : 0 FCFA, Accessoires : 0 FCFA -->
      </ul>
    </div>
    <!-- Top 5 des Produits les Plus Profitables -->
    <div class="report-card">
      <h2>Top 5 Produits les Plus Profitables</h2>
      <ol id="top-produits-profit">
        <!-- Liste des produits -->
      </ol>
    </div>
    <!-- Profit par Vendeur -->
    <div class="report-card">
      <h2>Profit par Vendeur</h2>
      <ul id="profit-par-vendeur">
        <!-- Exemple : Vendeur A : 0 FCFA, Vendeur B : 0 FCFA -->
      </ul>
    </div>
    <!-- Évolution du Profit -->
    <div class="chart-container">
      <h2>Évolution du Profit</h2>
      <canvas id="profitChart"></canvas>
    </div>
    <!-- Marge Bénéficiaire Moyenne -->
    <div class="report-card">
      <h2>Marge Bénéficiaire Moyenne</h2>
      <p id="marge-beneficiaire">0%</p>
    </div>
  </div>
</section>

<!-- CSS pour l'écran Profit -->
<style>
  #screen-profit {
    background-color: #ffffff;
    padding: 20px;
    min-height: calc(100vh - 60px);
    font-family: 'Roboto', sans-serif;
  }
  #screen-profit .rapport-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-bottom: 10px;
    border-bottom: 1px solid #e0e0e0;
  }
  #screen-profit .rapport-header h1 {
    font-size: 24px;
    color: #333;
    margin: 0;
  }
  #screen-profit .container {
    padding: 15px;
  }
  #screen-profit .report-card {
    background-color: #fff;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid #f0f0f0;
    transition: box-shadow 0.3s ease;
  }
  #screen-profit .report-card:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  }
  #screen-profit .report-card h2 {
    font-size: 20px;
    color: #006064;
    margin-bottom: 15px;
    border-bottom: 2px solid #006064;
    padding-bottom: 8px;
  }
  #screen-profit .report-card ul,
  #screen-profit .report-card ol {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  #screen-profit .report-card ul li,
  #screen-profit .report-card ol li {
    font-size: 16px;
    color: #555;
    margin-bottom: 10px;
  }
  #screen-profit .chart-container {
    background-color: #fff;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid #f0f0f0;
  }
  #screen-profit .chart-container h2 {
    font-size: 20px;
    color: #006064;
    margin-bottom: 15px;
    text-align: center;
  }
</style>

<!-- JavaScript pour l'écran Profit -->
<script>
  // Fonction pour mettre à jour les détails du profit
  function updateProfitDetails() {
    // Récupère toutes les ventes d'aujourd'hui (vous pouvez adapter ce filtre selon vos besoins)
    getSalesForTodayFirestore().then(sales => {
      // Profit Total et Profit Moyen par Vente
      let totalProfit = 0;
      sales.forEach(sale => {
        totalProfit += parseFloat(sale.totalProfit) || 0;
      });
      const profitMoyen = sales.length > 0 ? totalProfit / sales.length : 0;
      document.getElementById("detail-profit-moyen").textContent = profitMoyen.toLocaleString() + " FCFA";

      // === AJOUT DES LIGNES MANQUANTES POUR LA CARTE "PROFIT GLOBAL" ===
    
      // Profit par Catégorie
      const profitCategorie = {};
      sales.forEach(sale => {
        if (sale.items && Array.isArray(sale.items)) {
          sale.items.forEach(item => {
            // Supposons que chaque item possède un champ "categorie" (ou utilisez une valeur par défaut "Divers")
            const cat = item.categorie || "Divers";
            profitCategorie[cat] = (profitCategorie[cat] || 0) + (item.profitTotal || 0);
          });
        }
      });
      const ulCat = document.getElementById("profit-par-categorie");
      ulCat.innerHTML = "";
      for (const [cat, profit] of Object.entries(profitCategorie)) {
        const li = document.createElement("li");
        li.textContent = `${cat} : ${parseFloat(profit).toLocaleString()} FCFA`;
        ulCat.appendChild(li);
      }

      // Top 5 des Produits les Plus Profitables
      const profitParProduit = {};
      sales.forEach(sale => {
        if (sale.items && Array.isArray(sale.items)) {
          sale.items.forEach(item => {
            const prod = item.produit;
            profitParProduit[prod] = (profitParProduit[prod] || 0) + (item.profitTotal || 0);
          });
        }
      });
      const topProduits = Object.entries(profitParProduit)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
      const olTop = document.getElementById("top-produits-profit");
      olTop.innerHTML = "";
      topProduits.forEach(([prod, profit]) => {
        const li = document.createElement("li");
        li.textContent = `${prod} : ${parseFloat(profit).toLocaleString()} FCFA`;
        olTop.appendChild(li);
      });

      // Profit par Vendeur
      const profitParVendeur = {};
      sales.forEach(sale => {
        const vendeur = sale.vendeur || "Inconnu";
        profitParVendeur[vendeur] = (profitParVendeur[vendeur] || 0) + (parseFloat(sale.totalProfit) || 0);
      });
      const ulVendeur = document.getElementById("profit-par-vendeur");
      ulVendeur.innerHTML = "";
      for (const [vendeur, profit] of Object.entries(profitParVendeur)) {
        const li = document.createElement("li");
        li.textContent = `${vendeur} : ${parseFloat(profit).toLocaleString()} FCFA`;
        ulVendeur.appendChild(li);
      }

      // Calcul de la marge bénéficiaire moyenne
      let totalPrixVente = 0;
      let totalProfitUnitaire = 0;
      let totalQuantite = 0;
      sales.forEach(sale => {
        if (sale.items && Array.isArray(sale.items)) {
          sale.items.forEach(item => {
            totalPrixVente += parseFloat(item.prix) * item.quantite;
            totalProfitUnitaire += (parseFloat(item.profitUnitaire) || 0) * item.quantite;
            totalQuantite += item.quantite;
          });
        }
      });
      const marge = totalPrixVente > 0 ? (totalProfitUnitaire / totalPrixVente) * 100 : 0;
      document.getElementById("marge-beneficiaire").textContent = marge.toFixed(2) + "%";

      // Évolution du profit par heure (ou une autre période)
      const profitParHeure = new Array(24).fill(0);
      sales.forEach(sale => {
        const heure = new Date(sale.timestamp).getHours();
        profitParHeure[heure] += parseFloat(sale.totalProfit) || 0;
      });
      updateProfitChart(profitParHeure);
    }).catch(error => console.error("Erreur dans updateProfitDetails :", error));
  }

  // Fonction pour mettre à jour le graphique d'évolution du profit
  let profitChart;
  function updateProfitChart(profitParHeure) {
    const labels = profitParHeure.map((_, index) => index + "h");
    const ctx = document.getElementById("profitChart").getContext("2d");
    if (profitChart) {
      profitChart.data.labels = labels;
      profitChart.data.datasets[0].data = profitParHeure;
      profitChart.update();
    } else {
      profitChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "Profit par heure",
            data: profitParHeure,
            backgroundColor: "rgba(109, 93, 253, 0.2)",
            borderColor: "rgba(109, 93, 253, 1)",
            borderWidth: 2,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { display: true },
            y: { display: true, beginAtZero: true }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }
  }

  // Ajoutez ici la fonction updateProfitScreen()
function updateProfitScreen() {
  updateProfitDetails();
}
</script>

<!-- Section Approvisionnement -->
<section id="screen-approvisionnement" class="screen">
  <header>
    <button class="back-btn" onclick="window.location.hash='menu'">
      <i data-lucide="arrow-left"></i>
    </button>
    <h1>Approvisionnement</h1>
  </header>

  <!-- Formulaire d'approvisionnement -->
  <div class="form-section">
    <h2>Nouveau Approvisionnement</h2>
    <form class="vente-form" onsubmit="event.preventDefault(); ajouterApprovisionnementItem();">
      <!-- Champ Fournisseur -->
      <label for="fournisseurAppro">Fournisseur</label>
      <input type="text" id="fournisseurAppro" placeholder="Nom du fournisseur" required />

      <!-- Recherche du modèle de téléphone -->
      <label for="modeleAppro">Modèle de téléphone</label>
      <div class="input-container">
        <input type="text" id="modeleAppro" placeholder="Rechercher un modèle" autocomplete="off" required />
        <div id="suggestionListAppro" class="suggestion-list"></div>
      </div>
      <!-- Quantité -->
      <label for="quantiteAppro">Quantité achetée</label>
      <div class="quantity-container">
        <button type="button" onclick="decrementQuantityAppro()">–</button>
        <input type="number" id="quantiteAppro" min="1" value="1" required oninput="calculerCoutTotalAppro()" />
        <button type="button" onclick="incrementQuantityAppro()">+</button>
      </div>
      <!-- Prix d'achat unitaire -->
      <label for="prixAchatAppro">Prix d'achat unitaire (FCFA)</label>
      <input type="number" id="prixAchatAppro" placeholder="Prix d'achat" required oninput="calculerCoutTotalAppro()" />
      <!-- Coût total -->
      <label for="coutTotalAppro">Coût total</label>
      <input type="number" id="coutTotalAppro" placeholder="Calcul automatique" readonly />
      <button type="button" class="btn-modern" onclick="ajouterApprovisionnementItem()">Ajouter au panier</button>
    </form>
  </div>

  <!-- Panier Approvisionnement -->
  <div class="panier-approvisionnement">
    <h2>Panier Approvisionnement</h2>
    <div id="panierApproContent" class="list-container">
      <p>Le panier est vide.</p>
    </div>
    <button class="btn-modern" onclick="finaliserApprovisionnement()">Enregistrer Approvisionnement</button>
  </div>

  <!-- Historique des approvisionnements -->
  <div class="approvisionnement-history">
    <h2>Historique des Approvisionnements</h2>
    <div id="approvisionnementList" class="list-container">
      <!-- Les éléments de l'historique seront affichés ici -->
    </div>
  </div>
</section>

<!-- Styles et JS spécifiques à la section Approvisionnement -->
<style>
  /* Styles isolés pour #screen-approvisionnement */
  #screen-approvisionnement {
    background-color: #ffffff;
    padding: 20px;
    min-height: calc(100vh - 60px);
    font-family: 'Roboto', sans-serif;
  }
  #screen-approvisionnement header {
    text-align: center;
    margin-bottom: 15px;
    position: relative;
  }
  #screen-approvisionnement header h1 {
    font-size: 22px;
    color: #000;
  }
  /* Bouton retour */
  #screen-approvisionnement .back-btn {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #000;
  }
  /* Formulaire */
  #screen-approvisionnement .form-section {
    background: #ffffff;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  #screen-approvisionnement .form-section h2 {
    margin-bottom: 15px;
    color: #000;
    font-size: 20px;
    text-align: center;
  }
  #screen-approvisionnement .vente-form label {
    font-weight: 500;
    margin-bottom: 8px;
    display: block;
    font-size: 16px;
    color: #000;
  }
  #screen-approvisionnement .input-container {
    position: relative;
    margin-bottom: 16px;
  }
  #screen-approvisionnement .input-container input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 16px;
    color: #000;
  }
  #screen-approvisionnement .suggestion-list {
    position: absolute;
    background: #ffffff;
    border: 1px solid #ccc;
    z-index: 1000;
    max-height: 150px;
    overflow-y: auto;
    width: 100%;
    display: none;
  }
  #screen-approvisionnement .suggestion-item {
    padding: 8px 10px;
    cursor: pointer;
    color: #000;
  }
  #screen-approvisionnement .suggestion-item:hover {
    background: #f0f0f0;
  }
  /* Quantité */
  #screen-approvisionnement .quantity-container {
    display: flex;
    align-items: center;
    margin-bottom: 16px;
  }
  #screen-approvisionnement .quantity-container button {
    width: 40px;
    height: 40px;
    border: none;
    background: #E4E6EB;
    color: #000;
    font-size: 20px;
    border-radius: 50%;
    cursor: pointer;
  }
  #screen-approvisionnement .quantity-container input {
    text-align: center;
    width: 60px;
    margin: 0 8px;
    padding: 12px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 16px;
    color: #000;
  }
  /* Champs de saisie */
  #screen-approvisionnement input[type="number"],
  #screen-approvisionnement input[type="text"] {
    color: #000;
  }
  /* Bouton principal */
  #screen-approvisionnement .btn-modern {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    padding: 14px;
    font-size: 18px;
    font-weight: bold;
    text-align: center;
    border: none;
    border-radius: 50px;
    background: #E4E6EB;
    color: #000;
    box-shadow: none;
    cursor: pointer;
    margin-bottom: 10px;
  }
  /* Panier Approvisionnement */
  .panier-approvisionnement {
    background: #fafafa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  .panier-approvisionnement h2 {
    font-size: 20px;
    color: #000;
    margin-bottom: 10px;
    text-align: center;
  }
  .panier-approvisionnement .list-container {
    margin-bottom: 15px;
  }
  .panier-approvisionnement .list-container .panier-item {
    background: #ffffff;
    border: 1px solid #eee;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 10px;
    font-size: 16px;
  }
  .panier-approvisionnement .list-container .panier-item span.remove-item {
    color: red;
    cursor: pointer;
    float: right;
  }
  /* Historique des approvisionnements */
  #screen-approvisionnement .approvisionnement-history h2 {
    text-align: center;
    margin: 15px 0;
    font-size: 20px;
    color: #000;
  }
  #screen-approvisionnement .list-container {
    padding: 10px;
    background: #fafafa;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    max-height: 300px;
    overflow-y: auto;
  }
  #screen-approvisionnement .history-item {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    color: #000;
  }
  #screen-approvisionnement .history-item:last-child {
    border-bottom: none;
  }
</style>

<script>
  // Variable globale pour stocker les articles ajoutés au panier d'approvisionnement
  let currentApproItems = [];

  // Calcul du coût total d'approvisionnement
  function calculerCoutTotalAppro() {
    const quantite = parseFloat(document.getElementById("quantiteAppro").value) || 0;
    const prix = parseFloat(document.getElementById("prixAchatAppro").value) || 0;
    const total = quantite * prix;
    document.getElementById("coutTotalAppro").value = total.toFixed(2);
  }

  // Incrémenter/Décrémenter la quantité
  function decrementQuantityAppro() {
    const input = document.getElementById("quantiteAppro");
    let value = parseInt(input.value) || 1;
    if (value > 1) {
      input.value = --value;
      calculerCoutTotalAppro();
    }
  }
  function incrementQuantityAppro() {
    const input = document.getElementById("quantiteAppro");
    let value = parseInt(input.value) || 1;
    input.value = ++value;
    calculerCoutTotalAppro();
  }

  // Recherche en temps réel pour les modèles
  const modeleInput = document.getElementById("modeleAppro");
  const suggestionListAppro = document.getElementById("suggestionListAppro");
  modeleInput.addEventListener("input", function () {
    const query = this.value.trim().toLowerCase();
    suggestionListAppro.innerHTML = "";
    if (query === "") {
      suggestionListAppro.style.display = "none";
      return;
    }
    // Récupération des modèles de téléphones dans la collection "stock" avec catégorie "telephones"
    dbFirestore.collection("stock")
      .where("category", "==", "telephones")
      .get()
      .then(snapshot => {
        const models = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.name) {
            models.push(data.name);
          }
        });
        const filtered = models.filter(name => name.toLowerCase().includes(query));
        if (filtered.length === 0) {
          const noResult = document.createElement("div");
          noResult.className = "suggestion-item";
          noResult.textContent = "Aucun modèle trouvé";
          suggestionListAppro.appendChild(noResult);
        } else {
          filtered.forEach(model => {
            const div = document.createElement("div");
            div.className = "suggestion-item";
            div.textContent = model;
            div.addEventListener("click", function () {
              modeleInput.value = model;
              suggestionListAppro.innerHTML = "";
              suggestionListAppro.style.display = "none";
            });
            suggestionListAppro.appendChild(div);
          });
        }
        suggestionListAppro.style.display = "block";
      })
      .catch(err => {
        console.error("Erreur lors de la récupération des modèles : " + err.message);
        suggestionListAppro.innerHTML = "<div class='suggestion-item'>Erreur de récupération</div>";
        suggestionListAppro.style.display = "block";
      });
  });
  document.addEventListener("click", function (e) {
    if (e.target !== modeleInput) {
      suggestionListAppro.style.display = "none";
    }
  });

  // Fonction pour ajouter un article d'approvisionnement au panier
  function ajouterApprovisionnementItem() {
    const fournisseur = document.getElementById("fournisseurAppro").value.trim();
    const modele = document.getElementById("modeleAppro").value.trim();
    const quantite = parseFloat(document.getElementById("quantiteAppro").value);
    const prixAchat = parseFloat(document.getElementById("prixAchatAppro").value);
    const coutTotal = parseFloat(document.getElementById("coutTotalAppro").value);

    if (!fournisseur) {
      alert("Veuillez entrer le nom du fournisseur.");
      return;
    }
    if (!modele) {
      alert("Veuillez saisir le modèle de téléphone.");
      return;
    }
    if (!quantite || quantite <= 0) {
      alert("Veuillez entrer une quantité valide.");
      return;
    }
    if (!prixAchat || prixAchat <= 0) {
      alert("Veuillez entrer un prix d'achat valide.");
      return;
    }
    const item = {
      fournisseur,
      produit: modele,
      quantite,
      prixAchat,
      coutTotal: coutTotal.toFixed(2)
    };

    currentApproItems.push(item);
    updatePanierApprovisionnement();
    // Réinitialiser les champs relatifs à l'article (le fournisseur reste pour le groupe)
    document.getElementById("modeleAppro").value = "";
    document.getElementById("quantiteAppro").value = "1";
    document.getElementById("prixAchatAppro").value = "";
    document.getElementById("coutTotalAppro").value = "";
    suggestionListAppro.style.display = "none";
  }

  // Met à jour l'affichage du panier d'approvisionnement
  function updatePanierApprovisionnement() {
    const container = document.getElementById("panierApproContent");
    container.innerHTML = "";
    if (currentApproItems.length === 0) {
      container.innerHTML = "<p>Le panier est vide.</p>";
      return;
    }
    currentApproItems.forEach((item, index) => {
      const div = document.createElement("div");
      div.className = "panier-item";
      div.innerHTML = `<strong>${item.produit}</strong> - Qté: ${item.quantite} - Prix: ${item.prixAchat} FCFA - Total: ${item.coutTotal} FCFA <span class="remove-item" onclick="retirerApproItem(${index})">×</span>`;
      container.appendChild(div);
    });
  }

  // Permet de retirer un article du panier
  function retirerApproItem(index) {
    currentApproItems.splice(index, 1);
    updatePanierApprovisionnement();
  }

  function finaliserApprovisionnement() {
  if (currentApproItems.length === 0) {
    alert("Le panier est vide.");
    return;
  }

  // Supposons que tous les articles proviennent du même fournisseur
  const fournisseur = currentApproItems[0].fournisseur;

  // Calculer le coût total en sommant "coutTotal" de chaque article dans le panier
  const totalCost = currentApproItems.reduce((acc, item) => {
    return acc + parseFloat(item.coutTotal);
  }, 0);

  // Créer l'objet approvisionnement
  const approvisionnement = {
    fournisseur,
    items: currentApproItems,
    timestamp: Date.now()
  };

  // Enregistrer l'approvisionnement dans Firestore
  dbFirestore.collection("approvisionnement").add(approvisionnement)
    .then(() => {
      // Mettre à jour le stock pour chaque article
      const updatePromises = currentApproItems.map(item => {
        return ajouterOuMettreAJourStock(item.produit, item.quantite, item.prixAchat, "telephones");
      });
      return Promise.all(updatePromises);
    })
    .then(() => {
      // Déduire le montant total d'approvisionnement du solde de la trésorerie
      return getRunningBalance().then(soldeActuel => {
        const nouveauSolde = soldeActuel - totalCost;
        return setRunningBalance(nouveauSolde).then(() => totalCost);
      });
    })
    .then((totalCost) => {
      // Enregistrer la dépense fonctionnelle avec le libellé "Achats de m/ses de <fournisseur> - <montant>"
      const depense = {
        montant: totalCost,
        description: "Achats de m/ses de " + fournisseur + " - " + totalCost.toLocaleString() + " FCFA",
        type: "depense fonctionnelle",
        date: new Date().toISOString(),
        timestamp: Date.now()
      };
      return dbFirestore.collection("depenses").add(depense);
    })
    .then(() => {
  alert("Approvisionnement enregistré avec succès !");
  currentApproItems = [];
  updatePanierApprovisionnement();
  document.getElementById("fournisseurAppro").value = "";
  chargerApprovisionnements();
  updateStockSummary();
  // Ajout de l'actualisation du total des dépenses aujourd'hui
  updateBalanceDisplay();
})

    .catch(error => {
      alert("Erreur lors de l'ajout de l'approvisionnement : " + error.message);
    });
}


  // Charger l'historique dès l'accès à la page Approvisionnement
  window.addEventListener('load', function() {
    if(window.location.hash === '#approvisionnement'){
      chargerApprovisionnements();
    }
  });

  // Fonction pour charger l'historique des approvisionnements
  function chargerApprovisionnements() {
    dbFirestore.collection("approvisionnement")
      .orderBy("timestamp", "desc")
      .get()
      .then(snapshot => {
        const approList = document.getElementById("approvisionnementList");
        approList.innerHTML = "";
        snapshot.forEach(doc => {
          const appro = doc.data();
          const div = document.createElement("div");
          div.className = "history-item";
          let itemsText = "";
          if (appro.items && Array.isArray(appro.items)) {
            appro.items.forEach(item => {
              itemsText += `${item.produit} (Qté: ${item.quantite}, Prix: ${item.prixAchat} FCFA, Total: ${item.coutTotal} FCFA)<br>`;
            });
          }
          div.innerHTML = `
            <div>
              <strong>Fournisseur: ${appro.fournisseur}</strong><br>
              ${itemsText}
            </div>
            <small>${new Date(appro.timestamp).toLocaleString()}</small>
          `;
          approList.appendChild(div);
        });
      })
      .catch(error => {
        console.error("Erreur lors du chargement des approvisionnements : " + error.message);
      });
  }
</script>


    <!--Dépense Fonctionnelle -->
    <section id="screen-depense-fonctionnelle" class="screen">
      <style>
        .form-container {
          padding: 15px;
        }
        .form-section {
          background: var(--white);
          border-radius: var(--border-radius);
          padding: 20px;
          margin-bottom: 15px;
          box-shadow: var(--shadow);
        }
        .form-section h2 {
          text-align: center;
          color: var(--primary-color);
        }
        #formDepenseFonctionnelle input,
        #formDepenseFonctionnelle textarea {
          width: 100%;
          padding: 12px;
          font-size: 16px;
          border: none;
          border-radius: 50px;
          background: #E4E6EB;
          color: #333;
          margin-bottom: 10px;
          box-sizing: border-box;
          outline: none;
        }
        .btn-modern.primary {
          background: var(--primary-color);
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
        }
        .btn-modern.primary i {
          font-size: 20px;
        }
        .back-btn-fb {
          width: 40px;
          height: 40px;
          border: none;
          background: none;
          display: flex;
          align-items: center;
          justify-content: center;
          position: relative;
          border-radius: 50%;
          cursor: pointer;
          overflow: hidden;
          outline: none;
        }
        .back-btn-fb i {
          font-size: 24px;
          color: var(--primary-color);
        }
        .back-btn-fb::after {
          content: '';
          position: absolute;
          top: 50%;
          left: 50%;
          width: 200%;
          height: 200%;
          background: rgba(0, 0, 0, 0.1);
          border-radius: 50%;
          transform: translate(-50%, -50%) scale(0);
          transition: transform 0.3s ease-out;
          pointer-events: none;
        }
        .back-btn-fb:active::after {
          transform: translate(-50%, -50%) scale(1);
        }
      </style>

      <header>
        <button class="back-btn-fb" onclick="window.location.hash='depenses'">
          <i data-lucide="arrow-left"></i>
        </button>
        <h1>Nouvelle Dépense Fonctionnelle</h1>
      </header>

      <div class="form-container">
        <div class="form-section">
          <h2>Ajouter une Dépense</h2>
          <form id="formDepenseFonctionnelle">
            <label for="montantDepense">Montant (FCFA)</label>
            <input type="number" id="montantDepense" placeholder="Montant" required>

            <label for="descriptionDepense">Description</label>
            <textarea id="descriptionDepense" placeholder="Ex: Achat matériel de bureau" required></textarea>

            <button type="submit" class="btn-modern primary">
              <i data-lucide="plus"></i> Enregistrer Dépense
            </button>
          </form>
        </div>
      </div>

      <script>
        document.getElementById("formDepenseFonctionnelle").addEventListener("submit", function (e) {
  e.preventDefault();

  const montant = parseFloat(document.getElementById("montantDepense").value.trim());
  const description = document.getElementById("descriptionDepense").value.trim();

  if (!montant || montant <= 0) {
    alert("Veuillez entrer un montant valide.");
    return;
  }
  if (!description) {
    alert("Veuillez entrer une description.");
    return;
  }

  const depense = {
    montant: montant,
    description: description,
    type: "depense", // ou "papa", selon le cas
    date: new Date().toISOString(),
    timestamp: Date.now()
  };

  dbFirestore.collection("depenses").add(depense)
    .then(() => {
      // Récupérer le solde actuel
      return getRunningBalance();
    })
    .then(soldeActuel => {
      // Décrémenter le solde avec le montant de la dépense
      const nouveauSolde = soldeActuel - montant;
      return setRunningBalance(nouveauSolde);
    })
    .then(() => {
      alert("Dépense Fonctionnelle enregistrée avec succès !");
      document.getElementById("montantDepense").value = "";
      document.getElementById("descriptionDepense").value = "";
      updateBalanceDisplay(); // Rafraîchir l'affichage du solde
    })
    .catch(err => {
      alert("Erreur lors de l'ajout de la dépense : " + err.message);
    });
});


        window.addEventListener('hashchange', function () {
          if (window.location.hash === '#depense-fonctionnelle') {
            document.getElementById("montantDepense").value = "";
            document.getElementById("descriptionDepense").value = "";
          }
        });
      </script>
    </section>
    <!-- Screen: Dépense Papa -->
    <section id="screen-depense-papa" class="screen">
      <style>
        .form-container {
          padding: 15px;
        }
        .form-section {
          background: var(--white);
          border-radius: var(--border-radius);
          padding: 20px;
          margin-bottom: 15px;
          box-shadow: var(--shadow);
        }
        .form-section h2 {
          text-align: center;
          color: var(--primary-color);
        }
        /* Même style pour les inputs que pour l'écran Dépense Fonctionnelle */
        #formDepensePapa input,
        #formDepensePapa textarea {
          width: 100%;
          padding: 12px;
          font-size: 16px;
          border: none;
          border-radius: 50px;
          background: #E4E6EB;
          color: #333;
          margin-bottom: 10px;
          box-sizing: border-box;
          outline: none;
        }
        .btn-modern.primary {
          background: var(--primary-color);
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
        }
        .btn-modern.primary i {
          font-size: 20px;
        }
        .back-btn-fb {
          width: 40px;
          height: 40px;
          border: none;
          background: none;
          display: flex;
          align-items: center;
          justify-content: center;
          position: relative;
          border-radius: 50%;
          cursor: pointer;
          overflow: hidden;
          outline: none;
        }
        .back-btn-fb i {
          font-size: 24px;
          color: var(--primary-color);
        }
        .back-btn-fb::after {
          content: '';
          position: absolute;
          top: 50%;
          left: 50%;
          width: 200%;
          height: 200%;
          background: rgba(0, 0, 0, 0.1);
          border-radius: 50%;
          transform: translate(-50%, -50%) scale(0);
          transition: transform 0.3s ease-out;
          pointer-events: none;
        }
        .back-btn-fb:active::after {
          transform: translate(-50%, -50%) scale(1);
        }
      </style>

      <header>
        <button class="back-btn-fb" onclick="window.location.hash='depenses'">
          <i data-lucide="arrow-left"></i>
        </button>
        <h1>Nouvelle Dépense Papa</h1>
      </header>

      <div class="form-container">
        <div class="form-section">
          <h2>Ajouter une Dépense Papa</h2>
          <form id="formDepensePapa">
            <label for="montantDepensePapa">Montant (FCFA)</label>
            <input type="number" id="montantDepensePapa" placeholder="Montant" required>
            <label for="descriptionDepensePapa">Description</label>
            <textarea id="descriptionDepensePapa" placeholder="Ex: Description de la dépense" required></textarea>
            <button type="submit" class="btn-modern primary">
              <i data-lucide="plus"></i> Enregistrer Dépense Papa
            </button>
          </form>
        </div>
      </div>

      <script>
       document.getElementById("formDepensePapa").addEventListener("submit", function(e) {e.preventDefault();
        const montant = parseFloat(document.getElementById("montantDepensePapa").value.trim());
        const description = document.getElementById("descriptionDepensePapa").value.trim();
        
        if (!montant || montant <= 0) {
          alert("Veuillez entrer un montant valide.");
          return;
        }
        if (!description) {
          alert("Veuillez entrer une description.");
          return;
        }
        
        const depensePapa = {
          montant: montant,
          description: description,
          type: "papa",  // Pour identifier ce type de dépense
          date: new Date().toISOString(),
          timestamp: Date.now()
        };
        
        dbFirestore.collection("depenses").add(depensePapa)
          .then(() => {
            // Lancer en parallèle la mise à jour du solde des dépenses papa
            // ET la mise à jour du solde global.
            return Promise.all([
              updateDepensePapaBalance(), // Met à jour le document "depensePapa/balance"
              (function() {
                return getRunningBalance().then(currentGlobal => {
                  const nouveauGlobal = currentGlobal - montant;
                  return setRunningBalance(nouveauGlobal);
                });
              })()
            ]);
          })
          .then(() => {
            // On peut ensuite rafraîchir l'affichage (les deux soldes)
            updateBalanceDisplay();       // Pour le solde global
            updateDepensePapaButton();    // Pour le bouton "Dépense Papa"
            alert("Dépense Papa enregistrée avec succès !");
            document.getElementById("montantDepensePapa").value = "";
            document.getElementById("descriptionDepensePapa").value = "";
          })
          .catch(err => {
            alert("Erreur lors de l'ajout de la dépense papa : " + err.message);
          });
      });

            </script>
          </section>


<!-- Screen X : Panier -->
<section id="screen-panier" class="screen">
  <header>
    <button class="back-btn" onclick="window.location.hash='vendre'">
      <i data-lucide="arrow-left"></i> Retour
    </button>
    <h1>Mon Panier</h1>
  </header>

  <div style="padding: 15px;">
    <!-- articles injectés par JS -->
    <div id="panierContainer" class="list-container"></div>

    <!-- TOTAL PANIER -->
    <div id="panierTotal"
         style="text-align:right;font-size:18px;font-weight:bold;margin:12px 0;">
      Total : 0 FCFA
    </div>

    <div id="panierQuantity"
     style="text-align:right;font-size:16px;color:#555;margin-bottom:20px;">
  Qté totale : 0
</div>

    <!-- BOUTON SUIVANT -->
    <button id="btnPanierSuivant" class="btn-modern"
            onclick="continuerDepuisPanier()" disabled>
      Suivant <i data-lucide="arrow-right"></i>
    </button>
  </div>
</section>


<!-- Screen: Remboursement Papa -->
<section id="screen-remboursement-papa" class="screen">
  <style>
    .form-container {
      padding: 15px;
    }
    .form-section {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: var(--shadow);
    }
    .form-section h2 {
      text-align: center;
      color: var(--primary-color);
    }
    /* Styles pour les inputs */
    #formRemboursementPapa input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 50px;
      background: #E4E6EB;
      color: #333;
      margin-bottom: 10px;
      box-sizing: border-box;
      outline: none;
    }
    .btn-modern.primary {
      background: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-modern.primary i {
      font-size: 20px;
    }
    .back-btn-fb {
      width: 40px;
      height: 40px;
      border: none;
      background: none;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      border-radius: 50%;
      cursor: pointer;
      overflow: hidden;
      outline: none;
    }
    .back-btn-fb i {
      font-size: 24px;
      color: var(--primary-color);
    }
    .back-btn-fb::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 200%;
      height: 200%;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      transform: translate(-50%, -50%) scale(0);
      transition: transform 0.3s ease-out;
      pointer-events: none;
    }
    .back-btn-fb:active::after {
      transform: translate(-50%, -50%) scale(1);
    }
  </style>

  <header>
    <button class="back-btn-fb" onclick="window.location.hash='depenses'">
      <i data-lucide="arrow-left"></i>
    </button>
    <h1>Nouveau Remboursement Papa</h1>
  </header>

  <div class="form-container">
    <div class="form-section">
      <h2>Ajouter un Remboursement Papa</h2>
      <form id="formRemboursementPapa">
         <label for="montantRemboursementPapa">Montant (FCFA)</label>
         <input type="number" id="montantRemboursementPapa" placeholder="Montant" required>
         <button type="submit" class="btn-modern primary">
           <i data-lucide="plus"></i> Enregistrer Remboursement Papa
         </button>
      </form>
    </div>
  </div>

  <script>
    document.getElementById("formRemboursementPapa").addEventListener("submit", function(e) {
  e.preventDefault();
  
  const montant = parseFloat(document.getElementById("montantRemboursementPapa").value.trim());
  if (!montant || montant <= 0) {
    alert("Veuillez entrer un montant valide.");
    return;
  }
  
  const remboursement = {
    montant: montant,
    description: "Remboursement", // ou une description dynamique si besoin
    type: "remboursement",         // Permet d'identifier l'opération
    date: new Date().toISOString(),
    timestamp: Date.now()
  };
  
  dbFirestore.collection("remboursements").add(remboursement)
    .then(() => {
      // Mise à jour du solde global de trésorerie (reste inchangé)
      return getRunningBalance();
    })
    .then(soldeGlobal => {
      const nouveauGlobal = soldeGlobal + montant;
      return setRunningBalance(nouveauGlobal);
    })
    .then(() => {
      // MàJ du solde des dépenses Papa
      return getDepensePapaBalance();
    })
    .then(soldeDepPapa => {
      // Comme le remboursement "récupère" une partie du montant dépensé,
      // on soustrait ce montant du solde des dépenses Papa.
      const nouveauDepPapa = soldeDepPapa - montant;
      return setDepensePapaBalance(nouveauDepPapa);
    })
    .then(() => {
      alert("Remboursement enregistré avec succès !");
      document.getElementById("montantRemboursementPapa").value = "";
      updateBalanceDisplay(); // Mise à jour du solde global affiché
      updateDepensePapaButton(); // Mise à jour du bouton "Dépense Papa"
    })
    .catch(err => {
      alert("Erreur lors de l'ajout du remboursement : " + err.message);
    });
});


  </script>
</section>

    <!-- Bottom Navigation Modernisée (Navigation par hash) -->
    <nav class="bottom-nav-pro">
      <div class="nav-item" id="nav-vendre" onclick="window.location.hash='vendre'">
        <i data-lucide="shopping-cart"></i>
        <span>Vente</span>
      </div>
      <div class="nav-item" id="nav-panier" onclick="window.location.hash='panier'">
        <i data-lucide="shopping-bag"></i>
        <span>Panier</span>
      </div>
      
      <div class="nav-item" id="nav-stock" onclick="window.location.hash='stock'">
        <i data-lucide="package"></i>
        <span>Stock</span>
      </div>
      <div class="nav-item" id="nav-livraisons" onclick="window.location.hash='livraisons'">
        <i data-lucide="truck"></i>
        <span>Livraisons</span>
      </div>
      <div class="nav-item" id="nav-historique" onclick="window.location.hash='historique'">
        <i data-lucide="clock"></i>
        <span>Historique</span>
      </div>
      <div class="nav-item" id="nav-menu" onclick="window.location.hash='menu'">
        <i data-lucide="menu"></i>
        <span>Menu</span>
      </div>
    </nav>
  </div>
  
  <!-- Modal: Détails d'une vente -->
  <div id="modalDetail" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fermerModal()">&times;</span>
      <h2>Détails de la Vente</h2>
      <div id="detailContent"></div>
    </div>
  </div>
  

  
  <!-- Modal pour ajouter une opération -->
  <div id="modalAjoutOperation" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fermerModalTresorerie()">&times;</span>
      <h2>Ajouter une Opération</h2>
      <form class="vente-form">
        <label for="typeOperation">Type d'opération</label>
        <select id="typeOperation">
          <option value="entree">Entrée (Vente)</option>
          <option value="sortie">Dépense</option>
        </select>

        <label for="montantOperation">Montant</label>
        <input type="number" id="montantOperation" placeholder="Montant en FCFA" required>

        <label for="descriptionOperation">Observations</label>
        <textarea id="descriptionOperation" placeholder="Observations (facultatif)"></textarea>

        <button type="button" class="btn-modern" onclick="ajouterOperationTresorerie()">Ajouter</button>
      </form>
    </div>
  </div>

  
  
  <script>
    // Préloader
    window.addEventListener('load', function() {
      const preloader = document.getElementById('preloader');
      preloader.style.opacity = '0';
      setTimeout(() => { preloader.style.display = 'none'; }, 500);
    });

    // Toast Notification
    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.style.display = "block";
      setTimeout(() => { toast.style.display = "none"; }, 3000);
    }

    // Sale Loader Functions
    function showSaleLoader() {
      document.getElementById("saleLoader").style.display = "flex";
    }
    function hideSaleLoader() {
      document.getElementById("saleLoader").style.display = "none";
    }

    // Gestion des étapes de vente (Stepper)
    let currentStep = 0;
    const steps = document.querySelectorAll(".sale-step");
    function showStep(index) {
      steps.forEach((step, i) => {
        step.classList.remove("active");
        if(i === index) {
          step.classList.add("active");
        }
      });
      const progress = ((index + 1) / steps.length) * 100;
      document.getElementById("progressBar").style.width = progress + "%";
      document.getElementById("progressText").innerText = `Étape ${index + 1} / ${steps.length}`;
      if(index === steps.length - 1) {
        generateRecap();
      }
    }
    function nextStep() {
      if(currentStep < steps.length - 1) {
        currentStep++;
        showStep(currentStep);
      }
    }
    function prevStep() {
      if(currentStep > 0) {
        currentStep--;
        showStep(currentStep);
      }
    }
    function generateRecap() {
      const recap = document.getElementById("saleRecap");
      let html = "<h3>Récapitulatif de la Vente</h3><strong>Articles :</strong><br>";
      currentItems.forEach(item => {
        html += "• " + item.produit + " (Prix : " + item.prix + ", Qté : " + item.quantite + ", Total : " + item.total + ")<br>";
      });
      html += "<br><strong>Client :</strong> " + document.getElementById("clientNom").value + " (" + document.getElementById("clientNumero").value + ")<br>";
      html += "<strong>Vendeur :</strong> " + document.getElementById("vendeurSelect").value + "<br>";
      html += "<strong>Total :</strong> " + currentItems.reduce((acc, item) => acc + parseFloat(item.total), 0).toFixed(2);
      recap.innerHTML = html;
    }

    // Compression d'image
    function compressImage(file, maxWidth, maxHeight, quality, callback) {
      const reader = new FileReader();
      reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const ratio = Math.min(maxWidth / img.width, maxHeight / img.height);
          canvas.width = img.width * ratio;
          canvas.height = img.height * ratio;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          const dataUrl = canvas.toDataURL('image/jpeg', quality);
          callback(dataUrl);
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }

    // Initialisation Firebase et Firestore
    const firebaseConfig = {
      apiKey: "AIzaSyB44wUN_WitWSIjoUKtWXI6z6SuQx41_fg",
      authDomain: "africaphone1-accfb.firebaseapp.com",
      projectId: "africaphone1-accfb",
      storageBucket: "africaphone1-accfb.firebasestorage.app",
      messagingSenderId: "747416222232",
      appId: "1:747416222232:web:36cb8a93f3c8342ad3e16d",
      measurementId: "G-LFT6C3Q9D9"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.firestore().enablePersistence()
  .catch(err => {
    console.error("Erreur d'activation de la persistance Firestore:", err);
  });
    const dbFirestore = firebase.firestore();

    

    // Déclaration globale
let cachedStock = [];

// Fonction pour charger le stock depuis Firestore et le mettre en cache
function fetchAndCacheStock() {
  dbFirestore.collection("stock").get()
    .then(querySnapshot => {
      cachedStock = [];
      querySnapshot.forEach(doc => {
        cachedStock.push({ id: doc.id, ...doc.data() });
      });
      console.log("Stock chargé en cache :", cachedStock);
    })
    .catch(error => console.error("Erreur lors du chargement du stock :", error));
}

// Appeler la fonction dès le chargement de l'app
fetchAndCacheStock();

// Fonction debounce : exécute la fonction passée après un délai d'attente
function debounce(func, delay) {
  let timeoutId;
  return function(...args) {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => {
      func.apply(this, args);
    }, delay);
  };
}


    // --- Début de la gestion du solde "dépense papa" ---

  // Fonction pour récupérer le solde actuel de dépense papa
  function getDepensePapaBalance() {
    return dbFirestore.collection("depensePapa").doc("balance")
      .get()
      .then(doc => {
        if (doc.exists) {
          return doc.data().montant || 0;
        } else {
          // Si le document n'existe pas, retourner 0
          return 0;
        }
      })
      .catch(error => {
        console.error("Erreur lors de la récupération du solde de dépense papa :", error);
        return 0;
      });
  }

  // Fonction pour mettre à jour le solde de dépense papa
  function setDepensePapaBalance(newBalance) {
    return dbFirestore.collection("depensePapa").doc("balance").set({ montant: newBalance })
      .catch(error => {
        console.error("Erreur lors de la mise à jour du solde de dépense papa :", error);
      });
  }

  // Fonction pour mettre à jour le texte du bouton "Dépense Papa" avec le solde actuel
  function updateDepensePapaButton() {
    getDepensePapaBalance().then(balance => {
      const btn = document.getElementById("btnDepensePapa");
      if (btn) {
        btn.innerHTML = `<i data-lucide="user-minus"></i> Dépense Papa : ${balance.toLocaleString()} FCFA`;
        // Recharge les icônes Lucide
        lucide.createIcons();
      }
    }).catch(error => {
      console.error("Erreur lors de la mise à jour du bouton Dépense Papa :", error);
    });
  }

  // Fonction qui interroge la base pour récupérer la somme de toutes les dépenses de papa,
// met à jour le document "depensePapa/balance" et rafraîchit l'affichage sur le bouton.
function updateDepensePapaBalance() {
  console.log("Mise à jour du solde des dépenses Papa...");
  // Récupérer la somme des dépenses papa
  const depensesPromise = dbFirestore.collection("depenses")
    .where("type", "==", "papa")
    .get()
    .then(snapshot => {
      let totalDepenses = 0;
      snapshot.forEach(doc => {
        totalDepenses += parseFloat(doc.data().montant) || 0;
      });
      return totalDepenses;
    });
  
  // Récupérer la somme des remboursements (pour papa)
  const remboursementsPromise = dbFirestore.collection("remboursements")
    // Si nécessaire, vous pouvez filtrer ici uniquement pour les remboursements destinés aux "dépenses papa"
    .get()
    .then(snapshot => {
      let totalRemboursements = 0;
      snapshot.forEach(doc => {
        totalRemboursements += parseFloat(doc.data().montant) || 0;
      });
      return totalRemboursements;
    });
  
  return Promise.all([depensesPromise, remboursementsPromise])
    .then(([totalDepenses, totalRemboursements]) => {
      // Calculer le solde en soustrayant les remboursements des dépenses
      const newBalance = totalDepenses - totalRemboursements;
      return dbFirestore.collection("depensePapa").doc("balance").set({ montant: newBalance })
        .then(() => newBalance);
    })
    .then(newBalance => {
      console.log("Solde des dépenses Papa mis à jour :", newBalance);
      updateDepensePapaButton(); // Rafraîchit l'affichage du bouton
      return newBalance;
    })
    .catch(error => {
      console.error("Erreur dans updateDepensePapaBalance() :", error);
    });
}



  // --- Fin de la gestion du solde "dépense papa"

    /* === Fonctions centralisées pour le calcul des entrées, dépenses et solde === */
    function calculateEntreesToday() {
      const today = new Date();
      const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
      const endOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1).getTime() - 1;

      // Total des ventes de la journée
      const ventesPromise = dbFirestore.collection("ventes")
        .where("timestamp", ">=", startOfToday)
        .where("timestamp", "<=", endOfToday)
        .get()
        .then(snapshot => {
          let totalVentes = 0;
          snapshot.forEach(doc => {
            const data = doc.data();
            totalVentes += parseFloat(data.overallTotal) || 0;
          });
          return totalVentes;
        });

      // Total des remboursements de la journée
      const remboursementsPromise = dbFirestore.collection("remboursements")
        .where("timestamp", ">=", startOfToday)
        .where("timestamp", "<=", endOfToday)
        .get()
        .then(snapshot => {
          let totalRemboursements = 0;
          snapshot.forEach(doc => {
            const data = doc.data();
            totalRemboursements += parseFloat(data.montant) || 0;
          });
          return totalRemboursements;
        });

      return Promise.all([ventesPromise, remboursementsPromise])
        .then(([totalVentes, totalRemboursements]) => {
          return totalVentes + totalRemboursements;
        })
        .catch(error => {
          console.error("Erreur dans calculateEntreesToday : " + error.message);
          return 0;
        });
    }

    function calculateDepensesToday() {
  const today = new Date();
  const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
  const endOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1).getTime() - 1;

  return dbFirestore.collection("depenses")
    .where("timestamp", ">=", startOfToday)
    .where("timestamp", "<=", endOfToday)
    .get()
    .then(snapshot => {
      let totalDepenses = 0;
      snapshot.forEach(doc => {
        const data = doc.data();
        // On inclut "depense fonctionnelle" dans le calcul
        if (data.type === "depense" ||
            data.type === "depense fonctionnelle" ||
            data.type === "papa" ||
            !data.type) {
          totalDepenses += parseFloat(data.montant) || 0;
        }
      });
      return totalDepenses;
    })
    .catch(error => {
      console.error("Erreur dans calculateDepensesToday : " + error.message);
      return 0;
    });
}

    function updateBalanceDisplay() {
      Promise.all([
        calculateEntreesToday(),
        calculateDepensesToday(),
        getRunningBalance()   // Récupère le solde cumulatif à jour
      ])
      .then(([totalEntreesToday, totalDepensesToday, soldeCumulatif]) => {
        document.getElementById("entrees-today").textContent  = "+XOF " + totalEntreesToday.toLocaleString();
        document.getElementById("depenses-today").textContent = "-XOF " + totalDepensesToday.toLocaleString();
        document.getElementById("balance-sold").textContent   = "XOF " + soldeCumulatif.toLocaleString();
      })
      .catch(error => console.error("Erreur updateBalanceDisplay:", error));
    }

        /**
     * Récupère le solde cumulatif depuis le document "tresorerie/balance".
     * Retourne 0 si le doc n'existe pas ou en cas d'erreur.
     */
    function getRunningBalance() {
      return dbFirestore.collection("tresorerie").doc("balance")
        .get()
        .then(doc => {
          if (doc.exists) {
            const data = doc.data();
            return data.montant || 0;
          } else {
            // Si jamais le doc n'existe pas encore
            return 0;
          }
        })
        .catch(error => {
          console.error("Erreur getRunningBalance:", error.message);
          return 0;
        });
    }

    /**
     * Met à jour (ou crée) le document "tresorerie/balance" 
     * avec le nouveau solde passé en paramètre.
     */
    function setRunningBalance(nouveauSolde) {
      return dbFirestore.collection("tresorerie").doc("balance").set({
        montant: nouveauSolde
      })
      .catch(error => {
        console.error("Erreur setRunningBalance:", error.message);
      });
    }
    
    

    // Fonctions Firestore pour les ventes
    function addSaleFirestore(vente) {
      return dbFirestore.collection("ventes").add(vente)
        .then(docRef => docRef.id)
        .catch(error => { throw new Error("Erreur lors de l'ajout de la vente : " + error.message); });
    }
    function updateSaleFirestore(venteId, vente) {
      return dbFirestore.collection("ventes").doc(venteId).set(vente, { merge: true })
        .then(() => venteId)
        .catch(error => { throw new Error("Erreur lors de la mise à jour de la vente : " + error.message); });
    }
    function getSalesForTodayFirestore() {
      const today = new Date().toLocaleDateString("fr-FR");
      return dbFirestore.collection("ventes")
        .where("dateVente", "==", today)
        .get()
        .then(querySnapshot => {
          const ventes = [];
          querySnapshot.forEach(doc => {
            ventes.push({ id: doc.id, ...doc.data() });
          });
          return ventes;
        })
        .catch(error => { throw new Error("Erreur lors de la récupération des ventes : " + error.message); });
    }
    function getSaleByIdFirestore(id) {
      return dbFirestore.collection("ventes").doc(id).get()
        .then(doc => {
          if (doc.exists) {
            return { id: doc.id, ...doc.data() };
          } else {
            throw new Error("Vente non trouvée.");
          }
        })
        .catch(error => { throw new Error("Erreur lors de la récupération de la vente : " + error.message); });
    }
    function deleteSaleFirestore(id) {
      return dbFirestore.collection("ventes").doc(id).delete()
        .then(() => true)
        .catch(error => { throw new Error("Erreur lors de la suppression de la vente : " + error.message); });
    }

    function getAllSalesFirestore() {
  return dbFirestore.collection("ventes")
    .orderBy("timestamp", "desc")
    .get()
    .then(querySnapshot => {
      const ventes = [];
      querySnapshot.forEach(doc => {
        ventes.push({ id: doc.id, ...doc.data() });
      });
      return ventes;
    })
    .catch(error => { 
      throw new Error("Erreur lors de la récupération des ventes : " + error.message); 
    });
}


    // Fonctions Firestore pour le stock
    function getAllStockFirestore() {
  return new Promise((resolve, reject) => {
    dbFirestore.collection("stock").onSnapshot(snapshot => {
      const stocks = [];
      snapshot.forEach(doc => {
        stocks.push({ id: doc.id, ...doc.data() });
      });
      // Mettre à jour le cache global
      cachedStock = stocks;
      resolve(stocks);
    }, error => {
      reject(new Error("Erreur lors de la récupération du stock : " + error.message));
    });
  });
}

    function importStockToFirestore(stocks) {
      const batch = dbFirestore.batch();
      return dbFirestore.collection("stock").get()
        .then(querySnapshot => {
          querySnapshot.forEach(doc => {
            batch.delete(doc.ref);
          });
          stocks.forEach(stockItem => {
            const docRef = dbFirestore.collection("stock").doc();
            batch.set(docRef, stockItem);
          });
          return batch.commit();
        })
        .catch(error => { throw new Error("Erreur lors de l'importation du stock : " + error.message); });
    }
    function updateStockAfterSaleFirestore(items) {
      const promises = items.map(item => {
        return dbFirestore.collection("stock")
          .where("name", "==", item.produit)
          .get()
          .then(querySnapshot => {
            if (!querySnapshot.empty) {
              const doc = querySnapshot.docs[0];
              const stockData = doc.data();
              const newStock = Math.max(0, stockData.stock - item.quantite);
              return dbFirestore.collection("stock").doc(doc.id).update({ stock: newStock });
            }
          });
      });
      return Promise.all(promises).then(() => updateStockSummary());
    }
    function restockAfterCancellationFirestore(sale) {
      const promises = sale.items.map(item => {
        return dbFirestore.collection("stock")
          .where("name", "==", item.produit)
          .get()
          .then(querySnapshot => {
            if (!querySnapshot.empty) {
              const doc = querySnapshot.docs[0];
              const stockData = doc.data();
              const newStock = stockData.stock + item.quantite;
              return dbFirestore.collection("stock").doc(doc.id).update({ stock: newStock });
            }
          });
      });
      return Promise.all(promises).then(() => updateStockSummary());
    }

    // Mise à jour de l'affichage du stock
    function updateStockSummary() {
      getAllStockFirestore().then(stocks => {
        const totalTelephones = stocks.filter(s => s.category === 'telephones').reduce((sum, s) => sum + s.stock, 0);
        const totalAccessoires = stocks.filter(s => s.category === 'accessoires').reduce((sum, s) => sum + s.stock, 0);
        document.getElementById("total-telephones").innerText = totalTelephones;
        document.getElementById("total-accessoires").innerText = totalAccessoires;
      }).catch(err => console.error("Erreur dans updateStockSummary : " + err.message));
    }

    // Annulation de vente avec restockage
    function demanderAnnulation(id) {
      const motDePasse = prompt("Veuillez saisir le mot de passe pour annuler cette vente :");
      if (motDePasse !== "zizou") {
        alert("Mot de passe incorrect !");
        return;
      }
      if (confirm("Voulez-vous vraiment annuler cette vente ? Cela réintégrera les articles dans le stock.")) {
        getSaleByIdFirestore(id)
          .then(sale => {
            return restockAfterCancellationFirestore(sale).then(() => sale);
          })
          .then(sale => {
            return deleteSaleFirestore(sale.id);
          })
          .then(() => {
            alert("Vente annulée et stock mis à jour !");
            afficherVentes();
          })
          .catch(err => alert("Erreur lors de l'annulation : " + err.message));
      }
    }

    // Hash Router pour la navigation
    function handleHashChange() {
    const hash = window.location.hash.substring(1);
    showScreenByHash(hash);
    }
// Votre fonction enregistrerSnapshotDaily ici
function enregistrerSnapshotDaily() {
  const today = new Date();
  const todayString = today.toLocaleDateString("fr-FR");
  
  const historiqueRef = dbFirestore
    .collection("tresorerie")
    .doc("balance")
    .collection("historique");
  
  historiqueRef.where("dateString", "==", todayString).get()
    .then(snapshot => {
      if (snapshot.empty) {
        getRunningBalance().then(balance => {
          historiqueRef.add({
            date: firebase.firestore.Timestamp.fromDate(today),
            dateString: todayString,
            balance: balance
          })
          .then(() => {
            console.log("Snapshot enregistré pour " + todayString);
          })
          .catch(err => {
            console.error("Erreur lors de l'enregistrement du snapshot :", err.message);
          });
        });
      } else {
        console.log("Snapshot déjà existant pour " + todayString);
      }
    })
    .catch(err => {
      console.error("Erreur lors de la vérification du snapshot quotidien :", err.message);
    });
}

// Appel de la fonction lors du chargement de la page
window.addEventListener("load", () => {
  enregistrerSnapshotDaily();
});


  function showScreenByHash(hash) {
  // Masquer tous les écrans
  const allScreens = document.querySelectorAll('.screen');
  allScreens.forEach(screen => screen.classList.remove('active'));

  // Afficher l'écran correspondant au hash, sinon afficher "vendre" par défaut
  const targetScreen = document.getElementById(`screen-${hash}`);
  if (targetScreen) {
    targetScreen.classList.add('active');
  } else {
    document.getElementById('screen-vendre').classList.add('active');
    window.location.hash = 'vendre';
  }

  // Mettre à jour l'état actif de la navigation
  document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
  const activeNav = document.getElementById(`nav-${hash}`);
  if (activeNav) {
    activeNav.classList.add('active');
  }

  window.scrollTo(0, 0);

  // Gérer les cas spécifiques selon le hash
  switch (hash) {
    case 'vendre':
      break;
    case 'stock':
      updateStockSummary();
      break;
    case 'livraisons':
      afficherLivraisons();
      break;
    case 'historique':
         filterHistory();
      break;
    case 'depenses':
      chargerHistoriqueDepenses();
      updateBalanceDisplay();
      break;
    case 'tresorerie':
      updateBalanceDisplay();
      break;
    case 'rapports':
      // Appeler la fonction qui met à jour la section "Rapports & Statistiques"
      updateRapports();
      break;

    case 'approvisionnement':
        chargerApprovisionnements();
        break;
    case 'profit':
      updateProfitScreen(); // Appellez ici la fonction qui met à jour et affiche les détails du profit
        break;
    case 'repertoire-imei':
      // Code spécifique pour le répertoire d'IMEI, si nécessaire
      break;
    // Ajoutez d'autres cas si nécessaire

    case 'advance':  // Ajout du cas pour la section avance
      // Vous pouvez ajouter des actions spécifiques si besoin
      break;

      case 'panier':
  updatePanierPage();
  break;

  }
}


    window.addEventListener('load', () => {
      if (!window.location.hash) {
        window.location.hash = 'vendre';
      }
      handleHashChange();
      window.addEventListener('hashchange', handleHashChange);
      lucide.createIcons();

      updateDepensePapaBalance();
    });

    // Gestion du Panier (Vente)
    let currentItems = [];
 /* ========== PANIER ========== */

/* Affiche le contenu du panier, calcule le total,
   active/désactive le bouton “Suivant” */
   function updatePanierPage() {
  const container       = document.getElementById("panierContainer");
  const totalLabel      = document.getElementById("panierTotal");
  const quantityLabel   = document.getElementById("panierQuantity");
  const btnSuivant      = document.getElementById("btnPanierSuivant");

  container.innerHTML = "";
  if (currentItems.length === 0) {
    container.innerHTML    = "<p>Votre panier est vide.</p>";
    totalLabel.textContent = "Total : 0 FCFA";
    quantityLabel.textContent = "Qté totale : 0";
    btnSuivant.disabled    = true;
    return;
  }

  let total        = 0;
  let totalQuantity = 0;
  currentItems.forEach((item, index) => {
    total        += parseFloat(item.total);
    totalQuantity += parseInt(item.quantite, 10);
    container.innerHTML += `
      <div class="panier-item">
        <span class="remove-item" onclick="retirerArticle(${index})">&times;</span>
        <strong>${item.produit}</strong><br>
        Prix : ${item.prix} | Qté : ${item.quantite} | Total : ${item.total}
      </div>`;
  });

  totalLabel.textContent    = "Total : " + total.toLocaleString() + " FCFA";
  quantityLabel.textContent = "Qté totale : " + totalQuantity;
  btnSuivant.disabled       = false;
}

/* Supprime un article puis rafraîchit la vue courante */
function retirerArticle(index){
  currentItems.splice(index,1);
  if (window.location.hash === '#panier'){
    updatePanierPage();
  } else {
    updatePanier();                 // votre mini‑aperçu étape 1
  }
}

/* Passe du panier à l’étape 2 “Informations Client” */
function continuerDepuisPanier(){
  if (currentItems.length === 0){ return; }
  window.location.hash = 'vendre';  // revient au wizard
  currentStep = 1;                  // 0 = Étape 1, 1 = Étape 2
  showStep(currentStep);
}

/* Ouvre la page panier depuis l’étape 1 */
function ouvrirPanier(){
  window.location.hash = 'panier';
  updatePanierPage();
}
function ajouterArticle() {
  const produit  = document.getElementById("produit").value.trim();
  const prix     = parseFloat(document.getElementById("prix").value);
  const quantite = parseInt(document.getElementById("quantite").value);
  const total    = document.getElementById("totalArticle").value;

  if (!produit)                { alert("Veuillez sélectionner un article."); return; }
  if (!prix || prix <= 0)      { alert("Prix unitaire invalide.");          return; }
  if (!quantite || quantite<=0){ alert("Quantité invalide.");               return; }

  /* vérif stock via le cache */
  const stockItem = cachedStock.find(s => s.name.toLowerCase() === produit.toLowerCase());
  if (!stockItem)                    { alert("Article absent du stock.");   return; }
  if (quantite > stockItem.stock)    { alert("Stock insuffisant ("+stockItem.stock+")."); return; }

  /* ajout dans le panier */
  currentItems.push({ produit, prix, quantite, total });

  /* reset champs saisie */
  document.getElementById("produit").value  = "";
  document.getElementById("prix").value     = "";
  document.getElementById("quantite").value = 1;
  document.getElementById("totalArticle").value = "";

  showToast("Article ajouté au panier !");
  updatePanierPage();   // rafraîchit instantanément le total & le bouton
}

    function calculerTotalArticle() {
      const prix = parseFloat(document.getElementById("prix").value) || 0;
      const quantite = parseInt(document.getElementById("quantite").value) || 0;
      document.getElementById("totalArticle").value = (prix * quantite).toFixed(2);
    }
    function decrementQuantity() {
      const input = document.getElementById("quantite");
      let value = parseInt(input.value) || 1;
      if(value > 1) {
        input.value = --value;
        calculerTotalArticle();
      }
    }
    function incrementQuantity() {
      const input = document.getElementById("quantite");
      let value = parseInt(input.value) || 1;
      input.value = ++value;
      calculerTotalArticle();
    }

    // Gestion de la livraison dans la vente
    function toggleDeliveryFields() {
      const isDelivery = document.getElementById("isDelivery").checked;
      const deliveryFields = document.getElementById("deliveryFields");
      const btnValider = document.getElementById("btnValider");
      if(isDelivery) {
        deliveryFields.style.display = "block";
        btnValider.textContent = "Valider Livraison";
      } else {
        deliveryFields.style.display = "none";
        btnValider.textContent = "Valider Vente";
      }
    }
    function getValidationMessage() {
      return document.getElementById("isDelivery").checked ? "Valider la livraison ?" : "Valider la vente ?";
    }

    // Validation et finalisation de la vente
    function validerVente() {
      if(currentItems.length === 0) {
        alert("Veuillez ajouter au moins un article.");
        return;
      }
      const clientNom = document.getElementById("clientNom").value.trim();
      const clientNumero = document.getElementById("clientNumero").value.trim();
      if(!clientNom) {
        alert("Veuillez entrer le nom du client.");
        return;
      }
      if(!clientNumero) {
        alert("Veuillez entrer le numéro WhatsApp du client.");
        return;
      }
      const vendeur = document.getElementById("vendeurSelect").value;
      const photoFile = document.getElementById("photoFacture").files[0];
      const observationsVendeur = document.getElementById("observationsVendeur").value.trim();
      let isDelivery = document.getElementById("isDelivery").checked;
      let livreurNom = "";
      let livreurNumero = "";
      let lieuLivraison = "";
      if(isDelivery) {
        livreurNom = document.getElementById("livreurNom").value.trim();
        livreurNumero = document.getElementById("livreurNumero").value.trim();
        lieuLivraison = document.getElementById("lieuLivraison").value.trim();
        if(!livreurNom || !livreurNumero || !lieuLivraison) {
          alert("Veuillez remplir toutes les informations de livraison.");
          return;
        }
      }
      if(photoFile) {
        compressImage(photoFile, 800, 800, 0.7, function(compressedData) {
          finaliserVente(clientNom, clientNumero, vendeur, compressedData, observationsVendeur, isDelivery, livreurNom, livreurNumero, lieuLivraison);
        });
      } else {
        finaliserVente(clientNom, clientNumero, vendeur, null, observationsVendeur, isDelivery, livreurNom, livreurNumero, lieuLivraison);
      }
    }
    function finaliserVente(clientNom, clientNumero, vendeur, photoData, observationsVendeur, isDelivery, livreurNom, livreurNumero, lieuLivraison) {
  showSaleLoader();
  const now = new Date();
  const dateVente = now.toLocaleDateString("fr-FR");
  const heureVente = now.toLocaleTimeString("fr-FR");
  
  // Calcul de l'overallTotal et calcul du profit par article
  let overallTotal = 0;
  let totalProfit = 0;
  
  // Pour chaque article vendu, on calcule le profit en récupérant le coût d'achat moyen
  const profitCalculations = currentItems.map(item => {
    overallTotal += parseFloat(item.total);
    return dbFirestore.collection("stock")
      .where("name", "==", item.produit)
      .get()
      .then(querySnapshot => {
        if (!querySnapshot.empty) {
          const stockData = querySnapshot.docs[0].data();
          // Profit unitaire = Prix de vente saisi - coût moyen (stock.price)
          const profitUnitaire = item.prix - (stockData.price || 0);
          const profitTotal = profitUnitaire * item.quantite;
          totalProfit += profitTotal;
          // Vous pouvez aussi ajouter ce profit à l'article pour le report détaillé
          item.profitUnitaire = profitUnitaire;
          item.profitTotal = profitTotal;
        }
      });
  });
  
  // Attendre que tous les calculs de profit soient faits
  Promise.all(profitCalculations).then(() => {
    const vente = { 
      dateVente, 
      heureVente, 
      clientNom, 
      clientNumero, 
      vendeur,
      items: currentItems, 
      overallTotal: overallTotal.toFixed(2),
      totalProfit: totalProfit.toFixed(2), // Stocker le profit total de la vente
      photoFacture: photoData, 
      observationsVendeur,
      isDelivery,
      deliveryStatus: isDelivery ? "en cours" : null,
      timestamp: Date.now()
    };
    
    addSaleFirestore(vente)
      .then(() => updateStockAfterSaleFirestore(currentItems))
      .then(() => getRunningBalance())
      .then(soldeActuel => {
        const nouveauSolde = soldeActuel + parseFloat(overallTotal);
        return setRunningBalance(nouveauSolde);
      })
      .then(() => {
        hideSaleLoader();
        alert(isDelivery ? "Livraison validée !" : "Vente validée !");
        currentItems = [];
        document.getElementById("clientNom").value = "";
        document.getElementById("clientNumero").value = "";
        document.getElementById("photoFacture").value = "";
        document.getElementById("observationsVendeur").value = "";
        document.getElementById("isDelivery").checked = false;
        toggleDeliveryFields();
        afficherVentes();
        if(isDelivery) {
          afficherLivraisons();
        }
        updateBalanceDisplay();
      })
      .catch(error => {
        hideSaleLoader();
        alert("Erreur lors de l'ajout de la vente : " + error.message);
      });
  });
}


    // Compression de l'image via canvas
    function compressImage(file, maxWidth, maxHeight, quality, callback) {
      const reader = new FileReader();
      reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const ratio = Math.min(maxWidth / img.width, maxHeight / img.height);
          canvas.width = img.width * ratio;
          canvas.height = img.height * ratio;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          const dataUrl = canvas.toDataURL('image/jpeg', quality);
          callback(dataUrl);
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }

    // Affichage et détails des ventes
    function afficherVentes() {
  getAllSalesFirestore()
    .then(ventes => {
      const container = document.getElementById("ventesContainer");
      container.innerHTML = "";
      if (ventes.length === 0) {
        container.innerHTML = `
          <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 250px;">
            <i data-lucide="smile" style="width: 80px; height: 80px; color: #ccc;"></i>
            <p style="font-size: 18px; color: #888; margin-top: 20px;">
              Aucune vente enregistrée…
            </p>
          </div>`;
        lucide.createIcons();
        return;
      }
      ventes.forEach(sale => {
        const card = document.createElement("div");
        card.className = "vente-card";
        card.innerHTML = `
          <p><strong>${sale.clientNom}</strong> (${sale.clientNumero})</p>
          <p>Vendeur : ${sale.vendeur}</p>
          <p>Articles : ${sale.items ? sale.items.length : 0}</p>
          <p>Total : ${sale.overallTotal}</p>
          <button onclick="ouvrirDetails('${sale.id}')">Détails</button>
          <button class="delete-btn" onclick="demanderAnnulation('${sale.id}')" title="Annuler la vente">×</button>
        `;
        container.appendChild(card);
      });
    })
    .catch(error => console.error("Erreur lors de la récupération des ventes : " + error.message));
}

    
    // Affichage des livraisons
    function afficherLivraisons() {
      getSalesForTodayFirestore()
        .then(sales => {
          const livraisons = sales.filter(sale => sale.isDelivery);
          livraisons.sort((a, b) => b.id.localeCompare(a.id));
          const container = document.getElementById("livraisonsContainer");
          container.innerHTML = "";
          if(livraisons.length === 0) {
            container.innerHTML = "<p>Aucune livraison enregistrée aujourd'hui.</p>";
            return;
          }
          livraisons.forEach(sale => {
            let statusEmoji = "🟠 En cours";
            if(sale.deliveryStatus === "réussie") {
              statusEmoji = "🟢 Réussie";
            } else if(sale.deliveryStatus === "échouée") {
              statusEmoji = "🔴 Échouée";
            }
            const card = document.createElement("div");
            card.className = "vente-card";
            if(sale.deliveryStatus === "échouée") {
              card.classList.add("echouee");
            }
            let actionButtons = "";
            if(sale.deliveryStatus === "en cours") {
              actionButtons = 
                `<button onclick="marquerCommeReussie('${sale.id}')">Marquer comme Réussie</button>
                <button onclick="marquerCommeEchouee('${sale.id}')">Marquer comme Échouée</button>`;
            }
            card.innerHTML = 
              `<p><strong>${sale.clientNom}</strong> (${sale.clientNumero})</p>
              <p>Vendeur : ${sale.vendeur}</p>
              <p>Livraison par : ${sale.livreurNom || ""} (${sale.livreurNumero || ""})</p>
              <p>Lieu : ${sale.lieuLivraison || ""}</p>
              <p>Statut : ${statusEmoji}</p>
              <p>Total : ${sale.overallTotal}</p>
              <button onclick="ouvrirDetails('${sale.id}')">Détails</button>
              ${actionButtons}`;
            container.appendChild(card);
          });
        })
        .catch(error => console.error("Erreur lors de la récupération des livraisons : " + error.message));
    }
    
    // Fonctions de marquage des livraisons
    function marquerCommeReussie(id) {
      if(confirm("Voulez-vous marquer cette livraison comme réussie et la convertir en vente ?")) {
        getSaleByIdFirestore(id)
          .then(sale => {
            sale.deliveryStatus = "réussie";
            sale.convertedToSale = true;
            updateSaleFirestore(sale.id, sale)
              .then(() => {
                alert("Livraison marquée comme réussie et convertie en vente !");
                afficherLivraisons();
                afficherVentes();
              })
              .catch(error => alert("Erreur lors de la mise à jour de la vente : " + error.message));
          })
          .catch(error => alert("Erreur dans marquerCommeReussie : " + error.message));
      }
    }
    function marquerCommeEchouee(id) {
      if(confirm("Voulez-vous marquer cette livraison comme échouée ?")) {
        getSaleByIdFirestore(id)
          .then(sale => {
            sale.deliveryStatus = "échouée";
            updateSaleFirestore(sale.id, sale)
              .then(() => {
                alert("Livraison marquée comme échouée !");
                afficherLivraisons();
              })
              .catch(error => alert("Erreur lors de la mise à jour de la livraison : " + error.message));
          })
          .catch(error => alert("Erreur dans marquerCommeEchouee : " + error.message));
      }
    }
    
    // Détails d'une vente
    function ouvrirDetails(id) {
      getSaleByIdFirestore(id)
        .then(sale => {
          let articlesText = "";
          if (Array.isArray(sale.items)) {
            sale.items.forEach(item => {
              articlesText += "• " + item.produit + " (Prix : " + item.prix + ", Qté : " + item.quantite + ", Total : " + item.total + ")<br>";
            });
          } else {
            articlesText = "Aucun article.";
          }
          let detailHTML = 
            `<p><strong>Date :</strong> ${sale.dateVente}</p>
            <p><strong>Heure :</strong> ${sale.heureVente}</p>
            <p><strong>Client :</strong> ${sale.clientNom} (${sale.clientNumero})</p>
            <p><strong>Vendeur :</strong> ${sale.vendeur}</p>
            <p><strong>Articles :</strong><br>${articlesText}</p>
            <p><strong>Total Général :</strong> ${sale.overallTotal}</p>
            <p><strong>Observations :</strong> ${sale.observationsVendeur || "Aucune"}</p>`;
          if(sale.isDelivery) {
            let statusEmoji = "🟠 En cours";
            if(sale.deliveryStatus === "réussie") {
              statusEmoji = "🟢 Réussie";
            } else if(sale.deliveryStatus === "échouée") {
              statusEmoji = "🔴 Échouée";
            }
            detailHTML += 
              `<p><strong>Livraison par :</strong> ${sale.livreurNom} (${sale.livreurNumero})</p>
              <p><strong>Lieu de Livraison :</strong> ${sale.lieuLivraison}</p>
              <p><strong>Statut de Livraison :</strong> ${statusEmoji}</p>`;
          }
          if(sale.photoFacture) {
            detailHTML += `<p><strong>Photo :</strong><br>
                        <img src="${sale.photoFacture}" alt="Photo" style="max-width:100%; border-radius:5px;"></p>`;
          }
          document.getElementById("detailContent").innerHTML = detailHTML;
          document.getElementById("modalDetail").style.display = "flex";
        })
        .catch(error => console.error("Erreur lors de la récupération de la vente : " + error.message));
    }
    function fermerModal() {
      document.getElementById("modalDetail").style.display = "none";
    }
    window.onclick = function(event) {
      if (event.target === document.getElementById("modalDetail")) {
        fermerModal();
      }
      if (event.target === document.getElementById("modalPanier")) {
        fermerPanier();
      }
      if (event.target === document.getElementById("modalAjoutOperation")) {
        fermerModalTresorerie();
      }
    };

    // Export PDF (Format JSON)
    function exporterPDF() {
      const progressElem = document.getElementById("downloadProgress");
      progressElem.style.display = "block";
      progressElem.textContent = "Téléchargement en cours...";
      getSalesForTodayFirestore()
        .then(sales => {
          try {
            if (!sales || sales.length === 0) {
              throw new Error("Aucune vente récupérée.");
            }
            const jsonOutput = JSON.stringify(sales, (key, value) => {
              if(key === "photoRecu" || key === "photoFacture") return undefined;
              return value;
            }, 2);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(10);
            const lines = doc.splitTextToSize(jsonOutput, 180);
            doc.text(lines, 10, 10);
            doc.addJS("var p = app.response('Entrez le mot de passe pour ouvrir ce document :'); if(p !== 'Karim123456789,x1'){ app.alert('Mot de passe incorrect. Le document va être fermé.'); this.closeDoc(); }");
            doc.save("ventes_json.pdf");
            setTimeout(() => {
              progressElem.textContent = "Téléchargement terminé";
              setTimeout(() => { progressElem.style.display = "none"; }, 2000);
            }, 1000);
          } catch (e) {
            console.error("Erreur lors de l'exportation du PDF JSON : " + e.message);
            progressElem.textContent = "Erreur lors du téléchargement: " + e.message;
            setTimeout(() => { progressElem.style.display = "none"; }, 4000);
            alert("Erreur : " + e.message);
          }
        })
        .catch(error => {
          console.error("Erreur lors de l'exportation du PDF JSON : " + error.message);
          progressElem.textContent = "Erreur lors du téléchargement: " + error.message;
          setTimeout(() => { progressElem.style.display = "none"; }, 4000);
          alert("Erreur : " + error.message);
        });
    }

    // Export Factures PDF
    function exporterFacturesPDF() {
      getSalesForTodayFirestore()
        .then(sales => {
          try {
            const salesWithFacture = sales.filter(sale => sale.photoFacture);
            if (!salesWithFacture.length) {
              alert("Aucune vente avec facture disponible pour l'exportation.");
              return;
            }
            salesWithFacture.sort((a, b) => b.id.localeCompare(a.id));
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(14);
            doc.text("Factures des Ventes", 14, 15);
            doc.setFontSize(10);
            let currentY = 25;
            salesWithFacture.forEach((sale, index) => {
              if(index > 0) {
                doc.addPage();
                currentY = 20;
              }
              doc.text("Date : " + sale.dateVente, 14, currentY);
              currentY += 7;
              doc.text("Heure : " + sale.heureVente, 14, currentY);
              currentY += 7;
              doc.text("Client : " + sale.clientNom + " (" + sale.clientNumero + ")", 14, currentY);
              currentY += 7;
              doc.text("Observations : " + (sale.observationsVendeur || "Aucune"), 14, currentY);
              currentY += 7;
              try {
                doc.addImage(sale.photoFacture, "JPEG", 14, currentY, 60, 40);
                currentY += 50;
              } catch (err) {
                console.error("Erreur lors de l'ajout de l'image : " + err.message);
                alert("Erreur lors de l'ajout de l'image pour une vente: " + err.message);
              }
            });
            doc.addJS("var p = app.response('Entrez le mot de passe pour ouvrir ce document :'); if(p !== 'Karim123456789,x1'){ app.alert('Mot de passe incorrect. Le document va être fermé.'); this.closeDoc(); }");
            doc.save("factures.pdf");
          } catch (e) {
            console.error("Erreur lors de l'exportation des factures en PDF : " + e.message);
            alert("Erreur : " + e.message);
          }
        })
        .catch(error => {
          console.error("Erreur lors de l'exportation des factures en PDF : " + error.message);
          alert("Erreur : " + error.message);
        });
    }

    // Auto-suggestion pour la Vente
    const produitInput = document.getElementById("produit");
    const suggestionList = document.getElementById("suggestionList");
    produitInput.addEventListener("input", debounce(function () {
      const query = this.value.trim().toLowerCase();
      suggestionList.innerHTML = "";
      if (query === "") {
        suggestionList.style.display = "none";
        return;
      }
      // Utiliser le cache au lieu d'interroger Firestore à chaque saisie
      if (cachedStock.length === 0) {
        suggestionList.innerHTML = "<div class='suggestion-item no-result'>Données non chargées</div>";
        suggestionList.style.display = "block";
        return;
      }
      const produits = cachedStock.map(s => s.name);
      const filtered = produits.filter(name => name.toLowerCase().includes(query));
      if (filtered.length === 0) {
        const noResult = document.createElement("div");
        noResult.className = "suggestion-item no-result";
        noResult.textContent = "Aucun produit trouvé";
        suggestionList.appendChild(noResult);
      } else {
        filtered.forEach(prod => {
          const div = document.createElement("div");
          div.className = "suggestion-item";
          div.textContent = prod;
          div.addEventListener("click", function () {
            produitInput.value = prod;
            suggestionList.innerHTML = "";
            suggestionList.style.display = "none";
          });
          suggestionList.appendChild(div);
        });
      }
      suggestionList.style.display = "block";
    }, 300));


    // Auto-suggestion pour l'Entrée de Stock
    const produitEntreeInput = document.getElementById("produitEntree");
    const suggestionListEntree = document.getElementById("suggestionListEntree");
    produitEntreeInput.addEventListener("input", debounce(function () {
      const query = this.value.trim().toLowerCase();
      suggestionListEntree.innerHTML = "";
      if (query === "") {
        suggestionListEntree.style.display = "none";
        return;
      }
      // Utiliser le cache pour filtrer les produits
      if (cachedStock.length === 0) {
        suggestionListEntree.innerHTML = "<div class='suggestion-item no-result'>Données non chargées</div>";
        suggestionListEntree.style.display = "block";
        return;
      }
      const produits = cachedStock.map(s => s.name);
      const filtered = produits.filter(name => name.toLowerCase().includes(query));
      if (filtered.length === 0) {
        const noResult = document.createElement("div");
        noResult.className = "suggestion-item no-result";
        noResult.textContent = "Aucun produit trouvé";
        suggestionListEntree.appendChild(noResult);
      } else {
        filtered.forEach(prod => {
          const div = document.createElement("div");
          div.className = "suggestion-item";
          div.textContent = prod;
          div.addEventListener("click", function () {
            produitEntreeInput.value = prod;
            suggestionListEntree.innerHTML = "";
            suggestionListEntree.style.display = "none";
          });
          suggestionListEntree.appendChild(div);
        });
      }
      suggestionListEntree.style.display = "block";
    }, 300));


    // Gestion des onglets dans la section Stock
    function filterStockItems(category) {
      let searchTerm = "";
      let containerId = "";
      if(category === 'telephones'){
        const inputElement = document.getElementById("search-telephones");
        if (!inputElement) {
          console.error('L\'élément avec l\'id "search-telephones" n\'a pas été trouvé.');
          return;
        }
        searchTerm = inputElement.value.toLowerCase();
        containerId = "telephones-container";
      } else if(category === 'accessoires'){
        const inputElement = document.getElementById("search-accessoires");
        if (!inputElement) {
          console.error('L\'élément avec l\'id "search-accessoires" n\'a pas été trouvé.');
          return;
        }
        searchTerm = inputElement.value.toLowerCase();
        containerId = "accessoires-container";
      } else if(category === 'liste-prix'){
        const inputElement = document.getElementById("search-prix");
        if (!inputElement) {
          console.error('L\'élément avec l\'id "search-prix" n\'a pas été trouvé.');
          return;
        }
        searchTerm = inputElement.value.toLowerCase();
        containerId = "liste-prix-container";
      }
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      getAllStockFirestore().then(stocks => {
        let filteredProducts = stocks.filter(prod => prod.category === category && prod.name.toLowerCase().includes(searchTerm));
        if(filteredProducts.length === 0){
          container.innerHTML = "<p>Aucun produit trouvé.</p>";
          return;
        }
        if(category === 'liste-prix'){
          filteredProducts.forEach(prod => {
            const div = document.createElement("div");
            div.className = "price-item";
            div.innerHTML = `<p class="price-label">💰 Prix : ${prod.price.toLocaleString()} FCFA</p>`;
            container.appendChild(div);
          });
        } else {
          filteredProducts.forEach(prod => {
            const card = document.createElement("div");
            card.className = "product-card";
            card.innerHTML = 
              `<div class="product-icon">${prod.icon}</div>
              <div class="product-details">
                <h3>${prod.name}</h3>
                <p>🔹 Stock : ${prod.stock} unités</p>
                <p class="price-label">💰 Prix : ${prod.price.toLocaleString()} FCFA</p>
              </div>`;
            container.appendChild(card);
          });
        }
      }).catch(err => console.error("Erreur dans filterStockItems : " + err.message));
    }

    let currentStockCategory = "";
    function updateStockSummary() {
      getAllStockFirestore().then(stocks => {
        const totalTelephones = stocks.filter(s => s.category === 'telephones').reduce((sum, s) => sum + s.stock, 0);
        const totalAccessoires = stocks.filter(s => s.category === 'accessoires').reduce((sum, s) => sum + s.stock, 0);
        document.getElementById("total-telephones").innerText = totalTelephones;
        document.getElementById("total-accessoires").innerText = totalAccessoires;
      }).catch(err => console.error("Erreur dans updateStockSummary : " + err.message));
    }
    function showStockCategory(category) {
      currentStockCategory = category;
      document.getElementById("stock-home").style.display = "none";
      document.getElementById("stock-category").style.display = "block";
      const searchInput = document.getElementById("search-category");
      if (!searchInput) {
        console.error('L\'élément avec l\'id "search-category" n\'a pas été trouvé.');
        return;
      }
      searchInput.placeholder = category === "telephones" ? "Rechercher un téléphone..." : "Rechercher un accessoire...";
      searchInput.value = "";
      filterStockCategory();
    }
    function backToStockHome() {
      document.getElementById("stock-category").style.display = "none";
      document.getElementById("stock-home").style.display = "block";
    }
    function filterStockCategory() {
  const searchInput = document.getElementById("search-category");
  if (!searchInput) {
    console.error('L\'élément avec l\'id "search-category" n\'a pas été trouvé.');
    return;
  }
  const searchTerm = searchInput.value.toLowerCase();
  getAllStockFirestore().then(stocks => {
    let filteredProducts = stocks.filter(prod =>
      prod.category === currentStockCategory &&
      prod.name.toLowerCase().includes(searchTerm)
    );
    // Tri personnalisé : extraire le premier mot et lui attribuer un rang
    filteredProducts.sort((a, b) => {
      const firstA = a.name.split(" ")[0].toLowerCase();
      const firstB = b.name.split(" ")[0].toLowerCase();
      // Définition de l'ordre souhaité
      const ordre = { "tecno": 1, "infinix": 2, "itel": 3, "redmi": 4 };
      const rankA = ordre[firstA] || 5; // Les autres auront la valeur 5
      const rankB = ordre[firstB] || 5;
      if (rankA !== rankB) {
        return rankA - rankB;
      }
      // En cas d'égalité de rang, trier alphabétiquement par nom complet
      return a.name.localeCompare(b.name);
    });
    
    const container = document.getElementById("category-container");
    container.innerHTML = "";
    if (filteredProducts.length === 0) {
      container.innerHTML = "<p>Aucun produit trouvé.</p>";
      return;
    }
    filteredProducts.forEach(prod => {
      const card = document.createElement("div");
      card.className = "product-card";
      card.innerHTML =
        `<div class="product-icon">${prod.icon}</div>
         <div class="product-details">
           <h3>${prod.name}</h3>
           <p>🔹 Stock : ${prod.stock} unités</p>
           <p class="price-label">💰 Prix : ${prod.price.toLocaleString()} FCFA</p>
         </div>`;
      container.appendChild(card);
    });
  }).catch(err => console.error("Erreur dans filterStockCategory : " + err.message));
}

    // Importation du stock depuis un fichier TXT
    function importStockFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      readAndImport(file);
    }
    function readAndImport(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        parseStockText(text);
      };
      reader.readAsText(file);
    }
    function parseStockText(text) {
      const lines = text.split("\n");
      let importedStocks = [];
      const selectedCategory = document.getElementById("importCategorie").value;
      for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        if (!line) continue;
        if (line.toLowerCase().includes("articles")) continue;
        const parts = line.split("\t").filter(Boolean);
        if (parts.length < 3) continue;
        const name = parts[0].trim();
        const stock = parseInt(parts[1].trim());
        let priceText = parts[2].trim();
        let price = parseInt(priceText.replace(/[^\d]/g, ""));
        const category = selectedCategory;
        const icon = category === "accessoires" ? "🎧" : "📱";
        importedStocks.push({ name, category, stock, price, icon, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      }
      importStockToFirestore(importedStocks)
        .then(() => {
          alert("Stock importé avec succès !");
          updateStockSummary();
        })
        .catch(err => {
          alert("Erreur lors de l'importation du stock : " + err.message);
        });
    }

    // Gestion de l'Entrée de Stock
    function calculerTotalEntree() {
      const prix = parseFloat(document.getElementById("prixEntree").value) || 0;
      const quantite = parseInt(document.getElementById("quantiteEntree").value) || 0;
      document.getElementById("totalEntree").value = (prix * quantite).toFixed(2);
    }
    function decrementQuantityEntree() {
      const input = document.getElementById("quantiteEntree");
      let value = parseInt(input.value) || 1;
      if(value > 1) {
        input.value = --value;
        calculerTotalEntree();
      }
    }
    function incrementQuantityEntree() {
      const input = document.getElementById("quantiteEntree");
      let value = parseInt(input.value) || 1;
      input.value = ++value;
      calculerTotalEntree();
    }
    function ajouterEntreeStock() {
      const produit = document.getElementById("produitEntree").value.trim();
      const prix = parseFloat(document.getElementById("prixEntree").value);
      const quantite = parseInt(document.getElementById("quantiteEntree").value);
      const categorie = document.getElementById("categorieEntree").value;
      const total = document.getElementById("totalEntree").value;
      if(!produit) {
        alert("Veuillez saisir le nom de l'article.");
        return;
      }
      if(!prix || prix <= 0) {
        alert("Veuillez entrer un prix d'achat valide.");
        return;
      }
      if(!quantite || quantite <= 0) {
        alert("Veuillez entrer une quantité valide.");
        return;
      }
      ajouterOuMettreAJourStock(produit, quantite, prix, categorie)
        .then(() => {
          alert("Entrée de stock ajoutée !");
          document.getElementById("produitEntree").value = "";
          document.getElementById("prixEntree").value = "";
          document.getElementById("quantiteEntree").value = 1;
          document.getElementById("totalEntree").value = "";
          updateStockSummary();
        })
        .catch(err => {
          alert("Erreur lors de l'ajout de l'entrée de stock : " + err.message);
        });
    }
    function ajouterOuMettreAJourStock(produit, quantite, prix, categorie) {
  return dbFirestore.collection("stock")
    .where("name", "==", produit)
    .get()
    .then(querySnapshot => {
      if (!querySnapshot.empty) {
        const doc = querySnapshot.docs[0];
        const data = doc.data();
        const oldStock = parseFloat(data.stock) || 0;
        const oldPrice = parseFloat(data.price) || 0;
        const newStock = oldStock + quantite;
        // Calcul du prix moyen pondéré :
        // ((ancien stock * ancien prix) + (quantité approvisionnée * prix approvisionnement)) / nouveau stock
        const newPrice = ((oldStock * oldPrice) + (quantite * prix)) / newStock;
        return dbFirestore.collection("stock").doc(doc.id).update({
          stock: newStock,
          price: newPrice
        });
      } else {
        const icon = (categorie === "accessoires") ? "🎧" : "📱";
        const newRecord = { 
          name: produit, 
          stock: quantite, 
          price: prix, 
          category: categorie, 
          icon, 
          createdAt: firebase.firestore.FieldValue.serverTimestamp() 
        };
        return dbFirestore.collection("stock").add(newRecord);
      }
    });
}


    // Gestion des Vendeurs via Firestore
    function chargerVendeurs() {
      dbFirestore.collection("vendeurs").get()
        .then(querySnapshot => {
          const vendeurs = [];
          querySnapshot.forEach(doc => {
            vendeurs.push({ id: doc.id, ...doc.data() });
          });
          const select = document.getElementById("vendeurSelect");
          select.innerHTML = "";
          vendeurs.forEach(v => {
            const option = document.createElement("option");
            option.value = v.name;
            option.textContent = v.name;
            select.appendChild(option);
          });
          const liste = document.getElementById("listeVendeurs");
          liste.innerHTML = "";
          vendeurs.forEach(v => {
            const div = document.createElement("div");
            div.style.display = "flex";
            div.style.justifyContent = "space-between";
            div.style.alignItems = "center";
            div.style.marginBottom = "5px";
            div.textContent = v.name;
            const btn = document.createElement("button");
            btn.textContent = "Supprimer";
            btn.style.backgroundColor = "#ff6f00";
            btn.style.color = "#fff";
            btn.style.border = "none";
            btn.style.borderRadius = "4px";
            btn.style.cursor = "pointer";
            btn.onclick = function () { supprimerVendeur(v.id); };
            div.appendChild(btn);
            liste.appendChild(div);
          });
        })
        .catch(err => console.error("Erreur lors du chargement des vendeurs : " + err.message));
    }
    function ajouterVendeur() {
      const input = document.getElementById("nomVendeur");
      const nom = input.value.trim();
      if(nom === "") {
        alert("Veuillez saisir le nom du vendeur.");
        return;
      }
      dbFirestore.collection("vendeurs").add({
        name: nom,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        input.value = "";
        chargerVendeurs();
      })
      .catch(err => alert("Erreur lors de l'ajout du vendeur : " + err.message));
    }
    function supprimerVendeur(id) {
      dbFirestore.collection("vendeurs").doc(id).delete()
        .then(() => {
          chargerVendeurs();
        })
        .catch(err => alert("Erreur lors de la suppression du vendeur : " + err.message));
    }
    window.addEventListener("load", function() {
      chargerVendeurs();
    });

    // Vibration sur clic
    document.querySelectorAll('.btn-modern').forEach(button => {
      button.addEventListener('click', () => {
        if(navigator.vibrate) {
          navigator.vibrate(30);
        }
      });
    });
    window.addEventListener('load', () => {
      lucide.createIcons();
    });

    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        user.getIdTokenResult().then(idTokenResult => {
          // Récupère le rôle depuis les Custom Claims (par défaut "employe")
          window.userRole = idTokenResult.claims.role || "employe";
          console.log("Rôle de l'utilisateur :", window.userRole);
          ajusterInterfaceSelonRole(window.userRole);
          // Affiche l'application une fois que le rôle est connu
          document.getElementById("app").style.display = "block";
          
          // Pour le rôle "patron", rediriger immédiatement si la page actuelle n'est pas autorisée.
          if (window.userRole === "patron") {
            // Liste des écrans autorisés pour le patron
            const allowedHashes = ['#stock', '#historique', '#menu'];
            // Si le hash actuel n'est pas dans la liste, rediriger vers "#stock"
            if (!allowedHashes.includes(window.location.hash)) {
              window.location.hash = 'stock';
            }
          }
        }).catch(error => {
          console.error("Erreur lors de la récupération des Custom Claims :", error);
          window.location.href = 'login.html';
        });
      } else {
        window.location.href = 'login.html';
      }
    });

    function ajusterInterfaceSelonRole(role) {

      // applique une classe sur <body> selon le rôle
      document.body.classList.toggle('role-employe', role === 'employe');



      // Pour le menu de navigation
      if (role === "employe") {
        // Les employés ne voient pas le bouton Menu
        const navMenu = document.getElementById("nav-menu");
        if (navMenu) {
          navMenu.style.display = "none";
        }
        // Vous pouvez ajouter ici d'autres masquages spécifiques aux employés.
      } else if (role === "patron") {
        // Le patron ne doit voir que Stock, Historique et Menu.
        // Masquer Vente et Livraisons
        const navVendre = document.getElementById("nav-vendre");
        const navLivraisons = document.getElementById("nav-livraisons");
        if (navVendre) { navVendre.style.display = "none"; }
        if (navLivraisons) { navLivraisons.style.display = "none"; }
        // Dans l'écran Menu, n'afficher que Rapport & Statistiques, Trésorerie, Dépenses et Déconnexion.
        const sections = document.querySelectorAll("#screen-menu .section");
        sections.forEach(section => {
          const txt = section.textContent.toLowerCase();
          if (!(txt.includes("rapport") || txt.includes("trésorerie") || txt.includes("dépense") || txt.includes("déconnexion"))) {
            section.style.display = "none";
          }
        });
      } else if (role === "admin") {
        // Pour l'admin, tout doit être visible.
        const navMenu = document.getElementById("nav-menu");
        if (navMenu) { navMenu.style.display = "flex"; }
        const sections = document.querySelectorAll("#screen-menu .section");
        sections.forEach(section => {
          section.style.display = "flex";
        });

  

      }
    }


    function deconnexion() {
      firebase.auth().signOut().then(() => {
        window.location.href = 'login.html';
      }).catch(error => {
        alert("Erreur lors de la déconnexion: " + error.message);
      });
    }

    // Fonctions du Menu Principal
    function ouvrirGestionVendeurs() {
      alert('Ouvrir la page de gestion des vendeurs.');
    }

    // Actualisation de l'heure dans le menu
    function updateTimeMenu() {
      const menuTime = document.getElementById("current-time-menu");
      if(menuTime) {
        const now = new Date();
        menuTime.textContent = now.toLocaleTimeString("fr-FR", { hour: '2-digit', minute: '2-digit' });
      }
    }
    setInterval(updateTimeMenu, 1000);

    // *************** MODIFICATIONS POUR L'ÉCRAN DE RECHERCHE D'ARTICLE ***************
    produitInput.addEventListener('focus', function() {
      window.location.hash = 'search-article';
    });
    window.addEventListener('hashchange', function() {
      if(window.location.hash === '#search-article') {
        document.getElementById("searchProduitInput").value = "";
        document.getElementById("searchProduitInput").focus();
        loadProductsList();
      }
    });
    function loadProducts(query="") {
      const searchQuery = query.toLowerCase();
      getAllStockFirestore().then(stocks => {
        let filtered = stocks.filter(p => p.name.toLowerCase().includes(document.getElementById("searchProduitInput").value.toLowerCase()));
        const container = document.getElementById("searchProduitInput").parentNode.querySelector('.cards-container');
        container.innerHTML = "";
        if(filtered.length === 0) {
          container.innerHTML = "<p>Aucun produit trouvé.</p>";
          return;
        }
        filtered.forEach(prod => {
          const card = document.createElement("div");
          card.className = "product-card";
          card.innerHTML = `
            <div class="product-icon">${prod.icon}</div>
            <div class="product-details">
              <h3>${prod.name}</h3>
              <p>🔹 Stock : ${prod.stock} unités</p>
              <p class="price-label">💰 Prix : ${prod.price.toLocaleString()} FCFA</p>
            </div>`;
          card.onclick = function() {
            selectProduct(prod);
          };
          container.appendChild(card);
        });
      });
    }
    function loadProductsList() {
      loadProducts();
    }
    function selectProduct(prod) {
      document.getElementById("produit").value = prod.name;

      window.location.hash = 'vendre';
    }
    document.addEventListener("input", function(e) {
      if(e.target.id === "searchProduitInput") {
        loadProducts();
      }
    });
    // **********************************************************************************

    /* Fonctions pour la Trésorerie */
    function ouvrirFormOperationTresorerie() {
      document.getElementById("modalAjoutOperation").style.display = "flex";
    }
    function fermerModalTresorerie() {
      document.getElementById("modalAjoutOperation").style.display = "none";
    }
    function ajouterOperationTresorerie() {
      const type = document.getElementById("typeOperation").value;
      const montant = document.getElementById("montantOperation").value;
      const description = document.getElementById("descriptionOperation").value;
      alert("Opération ajoutée : " + type + " de " + montant + " FCFA");
      fermerModalTresorerie();
    }
  </script>
  <script>
    // Check if service workers are supported
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw.js')
          .then(function(registration) {
            console.log('Service Worker registered with scope:', registration.scope);
          })
          .catch(function(err) {
            console.log('Service Worker registration failed:', err);
          });
      });
    }
  </script>

  <script>
  let deferredPrompt;
  const installBtn = document.getElementById('installBtn');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'block';

    installBtn.addEventListener('click', () => {
      installBtn.style.display = 'none';
      deferredPrompt.prompt();

      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          console.log('User accepted the install prompt');
        } else {
          console.log('User dismissed the install prompt');
        }
        deferredPrompt = null;
      });
    });
  });
</script>

  
</body>
</html>
